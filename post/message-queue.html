<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>你真的了解消息队列吗 | 萨科的魔术盒</title>
    <meta name="description" content="YangQuan的个人博客网站">
    <link rel="preload stylesheet" href="/assets/style.31b25bb6.css" as="style">
    <link rel="modulepreload" href="/assets/app.0503c94e.js">
    <link rel="modulepreload" href="/assets/post_message-queue.md.b95ed7fa.lean.js">
    
    <meta name="viewport" content="user-scalable=0, initial-scale=1, maximum-scale=1, width=device-width">
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="me" href="https://mastodon.social/@Kourtsis">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="q-layout q-layout--standard" style="min-height:0px;" tabindex="-1"><!----><!----><header class="q-header q-layout__section--marginal fixed-top" style=""><div class="q-toolbar row no-wrap items-center" role="toolbar" drawer="false"><button class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--round q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" type="button"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="img">menu</i></span></button><div class="q-toolbar__title ellipsis col-shrink row items-center no-wrap"><div class="q-avatar" style=""><div class="q-avatar__content row flex-center overflow-hidden" style=""><img src="https://cdn.quasar.dev/logo-v2/svg/logo.svg" alt="logo"></div></div><span class="q-ml-sm">萨科的魔术盒</span></div><div class="q-space"></div><label class="q-field row no-wrap items-start q-field--standout q-input q-field--dense q-field--dark search-field search-closed" style="" for="f_deda544e-8c23-45fa-bfad-d8a8dd9be0cb"><!----><div class="q-field__inner relative-position col self-stretch"><div class="q-field__control relative-position row no-wrap" tabindex="-1"><div class="q-field__prepend q-field__marginal row no-wrap items-center"><i class="q-icon notranslate material-icons cursor-pointer" style="" aria-hidden="true" role="presentation">search</i></div><div class="q-field__control-container col relative-position row no-wrap q-anchor--skip"><input class="q-field__native q-placeholder" style="" tabindex="0" placeholder="Search" id="f_deda544e-8c23-45fa-bfad-d8a8dd9be0cb" type="text" value><!----></div></div><!----></div><!----></label><div class="q-space gt-sm"></div><!----></div><!----><div class="q-layout__shadow absolute-full overflow-hidden no-pointer-events"></div><!----></header><div class="q-drawer-container"><div class="fullscreen q-drawer__backdrop hidden" style="background-color:rgba(0,0,0,0);" aria-hidden="true"></div><aside class="q-drawer q-drawer--left q-layout--prevent-focus fixed q-drawer--on-top q-drawer--mobile q-drawer--top-padding" style="width:300px;transform:translateX(-300px);"><div class="q-drawer__content fit scroll"><div class="q-scrollarea fit"><div class="q-scrollarea__container scroll relative-position fit hide-scrollbar"><div class="q-scrollarea__content absolute" style=""><!----><div class="q-img q-img--menu" style="height:300px;" role="img"><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"><div class="absolute-bottom bg-transparent" style="text-align:center;"><div class="q-avatar q-mb-sm" style="font-size:150px;"><div class="q-avatar__content row flex-center overflow-hidden" style=""><img src="/avatar.webp" alt="avatar"></div></div><div class="text-weight-bold">Yang Quan</div><div>一个爱折腾的程序员 )=￣ω￣=)</div><div class="row"><!--[--><div class="col" style="text-align:center;"><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--round q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://mastodon.social/@Kourtsis"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><span class="q-icon" style="" aria-hidden="true" role="img"><svg viewBox="0 0 16 16"><path style="" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"></path></svg></span></span></a></div><div class="col" style="text-align:center;"><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--round q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://github.com/YangQuan666"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><span class="q-icon" style="" aria-hidden="true" role="img"><svg viewBox="0 0 16 16"><path style="" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg></span></span></a></div><div class="col" style="text-align:center;"><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--round q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://discord.gg/J8BVvnsWeB"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><span class="q-icon" style="" aria-hidden="true" role="img"><svg viewBox="0 0 16 16"><path style="" d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"></path></svg></span></span></a></div><!--]--></div></div></div></div><!--[--><div class="q-expansion-item q-item-type q-expansion-item--expanded q-expansion-item--standard" padding><div class="q-expansion-item__container relative-position"><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="button" tabindex="0" aria-expanded="true" aria-controls="6e7cf1b1-299a-429e-ab0a-2016c421851d" aria-label="Collapse &quot;主页&quot;"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">home</i></div><div class="q-item__section column q-item__section--main justify-center"><div style="" class="q-item__label">主页</div><!----></div></div><div class="q-expansion-item__content relative-position" style="" id="6e7cf1b1-299a-429e-ab0a-2016c421851d"><!--[--><!--]--></div></div></div><div class="q-expansion-item q-item-type q-expansion-item--expanded q-expansion-item--standard" padding><div class="q-expansion-item__container relative-position"><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="button" tabindex="0" aria-expanded="true" aria-controls="924a6de9-41db-4c8a-9caf-cdf3a662acbc" aria-label="Collapse &quot;小游戏&quot;"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">smart_toy</i></div><div class="q-item__section column q-item__section--main justify-center"><div style="" class="q-item__label">小游戏</div><!----></div><div class="q-item__section column q-item__section--side justify-center q-focusable relative-position cursor-pointer"><i class="q-icon notranslate material-icons q-expansion-item__toggle-icon q-expansion-item__toggle-icon--rotated" style="" aria-hidden="true" role="presentation">keyboard_arrow_down</i></div></div><div class="q-expansion-item__content relative-position" style="" id="924a6de9-41db-4c8a-9caf-cdf3a662acbc"><!--[--><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="listitem" tabindex="0"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"></div><div class="q-item__section column q-item__section--main justify-center">Chrome Dinosaur</div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">smart_toy</i></div></div><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="listitem" tabindex="0"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"></div><div class="q-item__section column q-item__section--main justify-center">Flappy Bird</div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">smart_toy</i></div></div><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="listitem" tabindex="0"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"></div><div class="q-item__section column q-item__section--main justify-center">2048</div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">smart_toy</i></div></div><!--]--></div></div></div><div class="q-expansion-item q-item-type q-expansion-item--expanded q-expansion-item--standard" padding><div class="q-expansion-item__container relative-position"><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="button" tabindex="0" aria-expanded="true" aria-controls="45afd195-b9c7-4e83-9a29-ac505a42b68f" aria-label="Collapse &quot;小工具&quot;"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">api</i></div><div class="q-item__section column q-item__section--main justify-center"><div style="" class="q-item__label">小工具</div><!----></div><div class="q-item__section column q-item__section--side justify-center q-focusable relative-position cursor-pointer"><i class="q-icon notranslate material-icons q-expansion-item__toggle-icon q-expansion-item__toggle-icon--rotated" style="" aria-hidden="true" role="presentation">keyboard_arrow_down</i></div></div><div class="q-expansion-item__content relative-position" style="" id="45afd195-b9c7-4e83-9a29-ac505a42b68f"><!--[--><div class="q-item q-item-type row no-wrap q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="" role="listitem" tabindex="0"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"></div><div class="q-item__section column q-item__section--main justify-center">Json Formatter</div><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">api</i></div></div><!--]--></div></div></div><!--]--></div><!----></div><!----><div class="q-scrollarea__bar q-scrollarea__bar--v absolute-right q-scrollarea__bar--invisible" style="" aria-hidden="true"></div><div class="q-scrollarea__bar q-scrollarea__bar--h absolute-bottom q-scrollarea__bar--invisible" style="" aria-hidden="true"></div><div class="q-scrollarea__thumb q-scrollarea__thumb--v absolute-right q-scrollarea__thumb--invisible" style="top:0px;height:0px;" aria-hidden="true"></div><div class="q-scrollarea__thumb q-scrollarea__thumb--h absolute-bottom q-scrollarea__thumb--invisible" style="left:0px;width:0px;" aria-hidden="true"></div></div></div></aside></div><div class="q-page-container" style="padding-top:50px;"><main class="q-page q-layout-padding" style="min-height:calc(100vh - 50px);"><!--[--><div class="q-img q-img--menu" style="height:400px;" role="img" aria-label="background"><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"><h3 class="absolute-full flex flex-center"> Talk is cheap. Show me the code. </h3></div></div><div class="row animate__animated animate__fadeIn"><div class="col-12 col-sm-10 offset-sm-1"><div class="q-card__actions justify-start q-card__actions--horiz row"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">schedule</i> 预计阅读分钟 <div class="q-space"></div><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">publish</i> 2022-11-11发表 </div><div style="position:relative;" class="markdown-body"><div><h1 id="你真的了解消息队列吗" tabindex="-1">你真的了解消息队列吗 <a class="header-anchor" href="#你真的了解消息队列吗" aria-hidden="true">#</a></h1><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h2 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-hidden="true">#</a></h2><p>消息队列（Message Queue），是分布式系统中重要的组件，能够帮助业务系统解构提升开发效率和系统稳定性。</p><p>消息队列主要具有以下优势： <strong>异步</strong>，<strong>解耦</strong>，<strong>削峰填谷</strong>（蓄洪）。</p><p>与此同时消息队列也可能带来如下的问题： <strong>数据丢失</strong>，<strong>数据重复</strong>，<strong>运维成本增加</strong></p><h2 id="术语" tabindex="-1">术语 <a class="header-anchor" href="#术语" aria-hidden="true">#</a></h2><h3 id="基础" tabindex="-1">基础 <a class="header-anchor" href="#基础" aria-hidden="true">#</a></h3><table><thead><tr><th><strong>中文</strong></th><th><strong>英文</strong></th><th><strong>释义</strong></th></tr></thead><tbody><tr><td>消息</td><td>Message</td><td>消息系统中信息传递的载体</td></tr><tr><td>消息主题</td><td>Topic</td><td>消息主题，一级消息类型，通过 Topic 对消息进行分类</td></tr><tr><td>消息标签</td><td>Tag</td><td>基于Topic下更细维度的区分</td></tr><tr><td>分区</td><td>Queue / Partition</td><td>每个 Topic 下会由一到多个队列来存储消息</td></tr><tr><td>消息生产者</td><td>Producer</td><td>负责生产并发送消息</td></tr><tr><td>消息消费者</td><td>Consumer</td><td>负责消息的消费</td></tr><tr><td>消费者分组</td><td>ConsumerGroup</td><td>由一类Consumer组成，共同消费同一个Topic的消息</td></tr><tr><td>订阅关系</td><td>Subscription</td><td>订阅关系，表示Consumer和Topic的映射关系，是消息中心投递消息给下游消费方的唯一依据</td></tr></tbody></table><h3 id="消息类型" tabindex="-1">消息类型 <a class="header-anchor" href="#消息类型" aria-hidden="true">#</a></h3><table><thead><tr><th>中文</th><th>英文</th><th>释义</th></tr></thead><tbody><tr><td>定时消息</td><td>Timer message</td><td>Producer 将消息发送到消息队列服务端，但并不期望这条消息立马投递，而是推迟到在当前时间点之后的某一个时间投递到 Consumer 进行消费，该消息即定时消息。</td></tr><tr><td>延时消息</td><td>Delayed message</td><td>Producer 将消息发送到消息队列服务端，但并不期望这条消息立马投递，而是延迟一定时间后才投递到 Consumer 进行消费，该消息即延时消息。</td></tr><tr><td>事务消息</td><td>Transactional message</td><td>消息队列提供类似 X/Open XA 的分布事务功能，通过消息队列的事务消息能达到分布式事务的最终一致。</td></tr><tr><td>顺序消息</td><td>Ordered message</td><td>消息队列提供的一种按照顺序进行发布和消费的消息类型，分为全局顺序消息和分区顺序消息，当前仅支持分区顺序消息。</td></tr></tbody></table><h3 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-hidden="true">#</a></h3><table><thead><tr><th>中文</th><th>英文</th><th>释义</th></tr></thead><tbody><tr><td>消息堆积</td><td>Message accumulation</td><td>Producer 已经将消息发送到消息队列的服务端，但由于 Consumer 消费能力有限，未能在短时间内将所有消息正确消费掉，此时在消息队列的服务端保存着未被消费的消息，该状态即消息堆积 。</td></tr><tr><td>消息轨迹</td><td>Message trace</td><td>在一条消息从 Producer 发出到 Consumer 消费处理过程中，由各个相关节点的时间、地点等数据汇聚而成的完整链路信息。</td></tr><tr><td>重置消费位点</td><td>Reset consumption offset</td><td>以时间轴为坐标，在消息持久化存储的时间范围内，重新设置 Consumer 对已订阅的 Topic 的消费进度，设置完成后 Consumer 将接收设定时间点之后由 Producer 发送到消息队列服务端的消息。</td></tr></tbody></table><h2 id="消费模式" tabindex="-1">消费模式 <a class="header-anchor" href="#消费模式" aria-hidden="true">#</a></h2><h3 id="拉模式" tabindex="-1">拉模式 <a class="header-anchor" href="#拉模式" aria-hidden="true">#</a></h3><h4 id="rocketmq" tabindex="-1">rocketmq <a class="header-anchor" href="#rocketmq" aria-hidden="true">#</a></h4><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><ul><li>拉 pull：消费者主动从消息中间件拉取消息 <ul><li>消息要求高可靠 <ul><li>消息中心消息可靠性由 DB 来保证</li></ul></li><li>消息实时性 <ul><li>消息中心是推模式，即使积压也能保证下游的实时性，但是牺牲了积压量</li><li>SOFAMQ 本质是拉模式，当有积压时，因为是顺序消费，下游消费实时性无法保证</li><li>非积压场景下，两个产品下游实时性基本一致，一般都在10ms左右 采用push模式，可以尽可能快的把消息发给消费者，但是如果消费者处理一条消息能力较弱（处理时间长），消息中间件会不断的发消息给消费者，到时消费者的缓存区溢出；采用pull模式，可能会增加消息的延迟。</li></ul></li></ul></li></ul><h3 id="推模式" tabindex="-1">推模式 <a class="header-anchor" href="#推模式" aria-hidden="true">#</a></h3><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><ul><li>推 push：由消息中间件主动发消息给消费者 <ul><li>消息量大，成本较低</li><li>实时数据平台</li><li>订阅端处理时间不可控 <ul><li>商户数据中心</li></ul></li><li>需要蓄洪，下游限流或泄洪消费 <ul><li>安全风控，大促时蓄洪，两小时后泄洪。</li></ul></li><li>支持大数据实时计算，按照设定时间来消费消息 <ul><li><a href="https://yuque.antfin-inc.com/kepler/taxxnc/vgn6f8" target="_blank" rel="noreferrer">BLINK</a></li></ul></li></ul></li></ul><h2 id="消息队列选型速览" tabindex="-1">消息队列选型速览 <a class="header-anchor" href="#消息队列选型速览" aria-hidden="true">#</a></h2><table><thead><tr><th><strong>功能特性</strong></th><th><strong>RocketMQ</strong></th><th><strong>MsgBroker（蚂蚁内部）</strong></th><th><strong>Kafka</strong></th><th><strong>RabbitMQ</strong></th></tr></thead><tbody><tr><td>事务消息</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>延迟消息</td><td>✅</td><td>✅</td><td>✅</td><td>🚫</td></tr><tr><td>优先级消息</td><td>🚫</td><td>🚫</td><td>🚫</td><td>✅</td></tr><tr><td>顺序消息</td><td>✅</td><td>🚫</td><td>✅</td><td>✅</td></tr><tr><td>消息轨迹</td><td>✅</td><td>✅</td><td>🚫</td><td>✅</td></tr><tr><td>消息过滤</td><td>✅</td><td>✅</td><td>🚫</td><td>🚫</td></tr><tr><td>消费模式</td><td>拉</td><td>推</td><td>拉</td><td>推、拉</td></tr><tr><td>积压能力</td><td>强（亿级）</td><td>弱（百万级）</td><td>强</td><td>弱</td></tr><tr><td>存储模式</td><td>磁盘</td><td>DB</td><td>磁盘</td><td>磁盘</td></tr><tr><td>可靠性</td><td>中</td><td>高</td><td>中</td><td>中</td></tr></tbody></table><h2 id="投递-消费语义" tabindex="-1">投递&amp;消费语义 <a class="header-anchor" href="#投递-消费语义" aria-hidden="true">#</a></h2><p><strong>投递语义</strong></p><table><thead><tr><th>投递语义</th><th>消息</th><th>生产者</th><th>消息队列</th><th>特点</th><th>例子</th></tr></thead><tbody><tr><td>最多投递一次</td><td>无需唯一编码</td><td>发送-&gt;不等ACK</td><td>消息无需持久化-&gt;无需ACK</td><td>可靠性低、吞吐最高</td><td>非核心日志采集</td></tr><tr><td>至少投递一次</td><td>无需唯一编码</td><td>发送-&gt;等消息队列ACK-&gt;失败重发</td><td>消息持久化-&gt;ACK</td><td>可靠性高</td><td>事件全量</td></tr><tr><td>恰好投递一次</td><td>唯一编码</td><td>发送-&gt;等消息队列ACK-&gt;失败则重发</td><td>【幂等】检查消息唯一性-&gt; 1.非重复消息-&gt;持久化-&gt;ACK 2. 重复消息-&gt;ACK</td><td>可靠性高</td><td></td></tr></tbody></table><p>【最多投递一次】SOFAMQ单向发送： <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 【至少投递一次】SOFAMQ同步发送、异步发送： <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><p><strong>消费语义</strong></p><table><thead><tr><th>消费语义</th><th>消息</th><th>生产者</th><th>消息队列</th><th>消费者</th><th>特点</th><th>例子</th></tr></thead><tbody><tr><td>最多消费一次</td><td>无需唯一编码</td><td>最多投递一次</td><td>分发-&gt;不等ACK</td><td>消费-&gt;无需ACK</td><td>可靠性低，吞吐最高</td><td>非核心日志采集</td></tr><tr><td>至少消费一次</td><td>无需唯一编码</td><td>至少投递一次 or 恰好投递一次</td><td>分发-&gt;等ACK-&gt;失败重发</td><td>消费-&gt;ACK</td><td>可靠性高</td><td>事件全量</td></tr><tr><td>恰好消费一次</td><td>唯一编码</td><td>至少投递一次 or 恰好投递一次</td><td>分发-&gt;等ACK-&gt;失败重发</td><td>【幂等检查消息唯一性 1.非重复消息-持久化-ACK 2.重复消息-ACK</td><td>可靠性高</td><td></td></tr></tbody></table><p>【至少消费一次】MsgBroker发送、订阅： <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h2 id="功能特性" tabindex="-1">功能特性 <a class="header-anchor" href="#功能特性" aria-hidden="true">#</a></h2><h3 id="事务消息" tabindex="-1">事务消息 <a class="header-anchor" href="#事务消息" aria-hidden="true">#</a></h3><p>使用场景 用户发起订单，支付100块钱操作完成后，能得到100积分，账户服务和会员服务是两个独立的微服务模块，有各自的数据库，按照上文提及的问题可能性，将会出现这些情况：</p><ul><li>如果先扣款，再发消息，可能钱刚扣完，消息没发失败了，结果积分没增加。</li><li>如果先发消息，再扣款，可能积分增加了，但钱没扣掉，白送了100积分</li><li>钱正常扣了，消息也发送成功了，但会员服务实例消费消息出现问题，结果积分没增加</li></ul><p><strong>事务消息就是保证本地事务操作和mq消息的发送是一致的，即本地事务成功，消息一定发送出去，本地事务失败，消息一定未被消费</strong></p><h6 id="整体流程" tabindex="-1">整体流程 <a class="header-anchor" href="#整体流程" aria-hidden="true">#</a></h6><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h6 id="异常情况" tabindex="-1">异常情况 <a class="header-anchor" href="#异常情况" aria-hidden="true">#</a></h6><ol><li>Producer发送半消息失败 可能由于网络或者mq故障，导致 Producer 发送半消息(prepare)失败，这时候发送方直接回滚本地事务就可以了</li><li>半消息发送成功，本地事务执行失败 发送方执行rollback给MQ，MQ会删除之前发送的半消息，消费端也就收不到这条消息</li><li>半消息发送成功，没收到MQ返回的响应 Check 被回调时，业务逻辑都需要做些什么？事务消息的 Check 方法里面，应该写一些检查事务一致性的逻辑。消息队列发送事务消息时需要实现 LocalTransactionChecker 接口，用来处理 Broker 主动发起的本地事务状态回查请求；因此在事务消息的 Check 方法中，需要完成两件事情： <ol><li>检查该半事务消息对应的本地事务的状态（committed or rollback）。</li><li>向 Broker 提交该半事务消息本地事务的状态。</li></ol></li></ol><p><strong>思考</strong>： RocketMQ是怎么保证半消息(prepare)不被消费者消费呢？</p><details class="details custom-block"><summary>答案</summary><ol><li>broker 端收到消息后，根据 TRAN_MSG 值判断是事务消息。则将消息转存到 topic: <code>RMQ_SYS_TRANS_HALF_TOPIC</code>，<code>queueId: 0</code></li><li>如果本地事务状态是<code>commit</code>，broker恢复原 <code>topic</code>，<code>queueId</code>, consumer 可以正常消费事务消息</li><li>如果本地事务状态是<code>rollback</code>，把消息放入<code>RMQ_SYS_TRANS_OP_HALF_TOPIC</code> 并通过设置<code>tags = d</code>标识该消息已被删除</li></ol></details><h3 id="延迟消息" tabindex="-1">延迟消息 <a class="header-anchor" href="#延迟消息" aria-hidden="true">#</a></h3><p>使用场景：用户下单未付款，30分钟后需要关闭订单</p><p>常见做法：使用redis的zset集合，将延迟任务按照过期时间排序，然后通过定时器去不断的轮训 优点：简单方便 缺点：占用的存储空间较大，定时轮询会造成不必要的请求</p><p>问：直接用DelayQueue怎么样？ 答：DelayQueue是JDK提供的延迟队列，对于有延迟需求的场景，直接用DelayQueue是可以的，但是不支持对延迟任务进行修改或删除操作，同时如果任务过多，会造成DelayQueue空间占用过大</p><h4 id="时间轮" tabindex="-1">时间轮 <a class="header-anchor" href="#时间轮" aria-hidden="true">#</a></h4><ol><li><p>Kafka中一个时间轮TimingWheel默认是由20个时间格组成，每格的时间跨度是1ms，时间轮底层采用数组实现，数组中的每个元素可以存放一个定时任务列表（TimerTaskList）。TimerTaskList是一个环形的双向链表，链表中的每一项表示的都是定时任务项（TimerTaskEntry），其中封装了真正的定时任务TimerTask</p><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p></li><li><p>假设初始的时候一个格子一秒，时间轮的指针定格在0。此时添加一个超时时间为2ms的任务, 那么这个任务将会插入到第二个时间格中 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p></li><li><p>时间轮的指针到达第二个时间格时, 会处理该时间格上对应的任务 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p></li><li><p>如果这个时候又插入一个延时时间为8ms的任务进来, 这个任务的过期时间就是在当前时间2ms的基础上加8ms, 也就是10ms, 那么这个任务将会插入到过期时间为10ms的时间格中。 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p></li><li><p>如果在当前时间是2ms的时候, 插入一个延时时间为19ms的任务时, 这个任务的过期时间就是在当前时间2s的基础上加19ms, 也就是21ms，那么这个任务就会插入到过期时间为21ms的时间格中</p></li></ol><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><ol start="6"><li>如果在当前时间是2ms的时候, 插入一个延时时间为22ms的任务, 这个任务的过期时间就是在2ms的基础上加22ms，也就是24ms，但是显然没有24ms的格子 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></li><li>第一层的时间轮装不下的时候，任务就会放入第二层的时间轮格子中 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></li><li>当第二层时间轮上的任务到期后，就会执行时间轮的降级，原本超时时间为24ms的任务会被从第二层取出来，放入第一层到期时间为24ms的格子中 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></li><li>从这里可以看出时间轮的巧妙之处，两层时间轮只用了40个数组元素，却可以承载[0-399s]的定时任务。而三层时间轮用60个数组元素，就可以承载[0-7999s] 的定时任务 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></li><li>插入一个延时时间400ms的任务, 指针就要执行399次&quot;空推进&quot;吗？ Kafka通过一个<code>DelayQueue</code>保存了所有的<code>TimerTaskList</code>对象，然后通过一个叫做<code>ExpiredOperationReaper</code>的线程从 <code>DelayQueue</code> 中获取超时的任务列表 <code>TimerTaskList</code>，然后根据<code>TimerTaskList</code> 的过期时间来精确推进时间轮的时间，这样就不会存在空推进的问题，</li></ol><p><strong>总结</strong></p><ul><li>Kafka 使用时间轮来实现延时队列，因为其底层是任务的添加和删除是基于链表实现的，是 O(1) 的时间复杂度，满足高性能的要求</li><li>DelayQueue 只存放了 TimerTaskList，并不是所有的 TimerTask，数量并不多，相比空推进带来的影响是利大于弊的</li><li>对于时间跨度大的延时任务，Kafka 引入了层级时间轮，能更好控制时间粒度，可以应对更加复杂的定时任务处理场景</li></ul><h6 id="rocketmq内部版" tabindex="-1">rocketmq内部版 <a class="header-anchor" href="#rocketmq内部版" aria-hidden="true">#</a></h6><p>rocketmq在kafka的时间轮基础上提供了延迟消息可靠的存储方式</p><ol><li><p>时间轮的每一格设计如下</p><p>| delay_time(8B) 延迟时间 | first_pos 首条位置 | last_pos(8B) 最后位置 | num(4B) 消息条数 | |---------------------|----------------|-------------------|--------------|</p></li><li><p>TimerLog，定时消息的记录文件，Append Only。每条记录包含一个prev_pos，指向前一条定时到同样时刻的记录</p></li><li><p>TimerLog与TimerWheel的协作如下图所示 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p></li><li><p>消息的存储工作流程如下： <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><ol><li>针对放置定时消息的service，每50ms从commitLog读取指定topic的定时消息 <ol><li>TimerEnqueueGetService从commitLog读取得到定时主题的消息，并先将其放入enqueuePutQueue</li><li>另一个线程TimerEnqueuePutService将其放入timerLog,更新时间轮的存储内容。将该任务放进时间轮的指定位置</li></ol></li><li>针对取出定时消息的service，每50ms读取下一秒的slot。有三个线程将读取到的消息重新放回commitLog <ol><li>首先，TimerDequeueGetService每50ms读一次下一秒的slot，从timerLog中得到指定的msgs，并放进dequeueGetQueue</li><li>而后TimerDequeueGetMessageService从dequeueGetQueue中取出msg，并将其放入队列中。该队列为待写入commitLog的队列，dequeuePutQueue</li><li>最后TimerDequeuePutMessageService将这个queue中的消息取出，若已到期则修改topic，放回commitlog，否则继续按原topic写回CommitLog滚动</li></ol></li></ol></li></ol><p>缺点</p><ul><li>只能精确到秒级</li><li>顺序的写会带来随机的读，导致读取性能较低</li></ul><h6 id="rocketmq社区版" tabindex="-1">rocketmq社区版 <a class="header-anchor" href="#rocketmq社区版" aria-hidden="true">#</a></h6><p>RocketMQ社区版支持延迟消息，但是不支持任意时间精度的延迟消息，只支持特定级别的延迟消息 消息延迟级别分别为<strong>1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</strong>，共18个级别。在发送消息时，设置消息延迟级别即可，设置消息延迟级别时有以下3种情况：</p><ol><li>设置消息延迟级别等于0时，则该消息为非延迟消息。</li><li>设置消息延迟级别大于等于1并且小于等于18时，消息延迟特定时间，如：设置消息延迟级别等于1，则延迟1s；设置消息延迟级别等于2，则延迟5s，以此类推。</li><li>设置消息延迟级别大于18时，则该消息延迟级别为18，如：设置消息延迟级别等于20，则延迟2h。</li></ol><p><strong>原理</strong> RocketMQ发送延时消息时先把消息按照延迟时间段发送到指定的队列中，然后通过一个定时器进行轮训这些队列，查看消息是否到期，如果到期就把这个消息发送到指定topic的队列中，这样的好处是同一队列中的消息延时时间是一致的，还有一个好处是这个队列中的消息时按照消息到期时间进行递增排序的，说的简单直白就是队列中消息越靠前的到期时间越早。</p><h5 id="顺序消息" tabindex="-1">顺序消息 <a class="header-anchor" href="#顺序消息" aria-hidden="true">#</a></h5><h6 id="kafka" tabindex="-1">kafka <a class="header-anchor" href="#kafka" aria-hidden="true">#</a></h6><p>kafka可以通过key，将某类消息写入同一个partition，一个partition只能对应一个消费者，以保证数据有序。 问：生产者先后两条消息发送时，前一条消息发送失败，后一条消息发送成功，然后失败的消息重试后发送成功，会不会造成消息乱序？ 答：为了解决重试机制引起的消息乱序，Kafka引入了Producer ID（即PID）和 Sequence Number</p><ul><li>在 producer 端，每个 producer 都被 broker 自动分配了一个 PID， producer 向 broker 发送的每条消息，在内部都附带着该 PID 和一个递增的 Sequence Number</li><li>在 broker 端，broker 为每个 topic 的每个 partition 都维护了一个当前写成功的消息的最大 <code>&lt;PID, Sequence Number&gt;</code>元组</li></ul><p>如果消息序号比Broker维护的序号差值大于1，说明中间有数据尚未写入，即乱序，此时Broker拒绝该消息，如果消息序号小于等于Broker维护的序号，说明该消息已被保存，即为重复消息，Broker直接丢弃该消息，发送失败后会重试，这样可以保证每个消息都被发送到broker</p><p>问：只有一个partation会导致消费者的吞吐量变低，如果消费者启用多线程消费，则消息重新变得无序，如何解决？ 答：消费者端创建多个内存队列，具有相同 key 的数据都路由到同一个内存 队列；然后每个线程分别消费一个内存队列即可，这样就能保证顺序性。如下图：</p><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h4 id="消息轨迹" tabindex="-1">消息轨迹 <a class="header-anchor" href="#消息轨迹" aria-hidden="true">#</a></h4><p>一条消息的生命周期包含多个阶段：发送端发送，服务端收到消息、写入消息、投递消息等。而用户在使用MQ时，有时会想知道消息的发送、投递、消费情况，以及消费耗时、消费节点、是否重投等信息。这些信息都属于消息轨迹。 在没有可视化的消息轨迹界面时，轨迹信息都是通过原始的翻日志的方式来查询。需要根据机器节点的日志信息找到链路，一步一步溯源查找。</p><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 既然把消息轨迹当成消息存储在Broker服务器，那存储消息轨迹的Topic如何确定呢？RocketMQ提供了两种方法来定义消息轨迹的Topic。</p><ul><li>系统默认Topic</li></ul><p>如果Broker的traceTopicEnable配置设置为true，表示在该Broker上创建topic名为： RMQ_SYS_TRACE_TOPIC，队列个数为1，默认该值为false，表示该Broker不承载系统自定义用于存储消息轨迹的topic。</p><ul><li>自定义Topic</li></ul><p>在创建消息生产者或消息消费者时，可以通过参数自定义用于记录消息轨迹的Topic名称，不过要注意的是，rokcetmq控制台(rocketmq-console) 中只支持配置一个消息轨迹Topic，故自定义Topic，在目前这个阶段或许还不是一个最佳实践，建议使用系统默认的Topic即可。 通常为了避免消息轨迹的数据与正常的业务数据混合在一起，官方建议，在Broker集群中，新增加一台机器，只在这台机器上开启消息轨迹跟踪，这样该集群内的消息轨迹数据只会发送到这一台Broker服务器上，并不会增加集群内原先业务Broker的负载压力。</p><h3 id="稳定性-性能" tabindex="-1">稳定性&amp;性能 <a class="header-anchor" href="#稳定性-性能" aria-hidden="true">#</a></h3><h4 id="高可用" tabindex="-1">高可用 <a class="header-anchor" href="#高可用" aria-hidden="true">#</a></h4><h5 id="ack机制" tabindex="-1">ACK机制 <a class="header-anchor" href="#ack机制" aria-hidden="true">#</a></h5><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div>##### 数据备份和故障转移 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h5 id="消费一致性" tabindex="-1">消费一致性 <a class="header-anchor" href="#消费一致性" aria-hidden="true">#</a></h5><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> LogEndOffset：每个partition的log最后一条Message的位置。 HighWatermark：取最小LEO，consumer能够看到的此partition的位置。</p><h4 id="高性能" tabindex="-1">高性能 <a class="header-anchor" href="#高性能" aria-hidden="true">#</a></h4><h5 id="零拷贝" tabindex="-1">零拷贝 <a class="header-anchor" href="#零拷贝" aria-hidden="true">#</a></h5><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h5 id="磁盘顺序读写" tabindex="-1">磁盘顺序读写 <a class="header-anchor" href="#磁盘顺序读写" aria-hidden="true">#</a></h5><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h4 id="msgbroker" tabindex="-1">msgbroker <a class="header-anchor" href="#msgbroker" aria-hidden="true">#</a></h4><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 在2.0的模型中将normal message table拆分为了多个表，并且在逻辑上组成了一个环，按照时间进行写入表的切换，并且定期批量的进行过期表中的数据删除。消息投递之后只会记录 checkpoint，标记哪些消息已经可以删除了，而不会真正执行 normal message table 中的数据删除，从而避免了频繁的插入和删除操作。可以简单的理解为2.0的模型写入就是不断的 Append 消息（checkpoint 可以理解为 offset），投递就是不断的推进checkpoint，删除是批量的对过期的表（不再进行读写）进行删除。</p><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> MsgBroker 2.0的计算模型设计中采用了全异步的模型，对各个开销较高的操作都做了异步化，比如msg-write-threads（消息写入线程池）仅负责消息写入时的业务逻辑，并不处理持久化操作。持久化操作是耗时的，由msg-flush-threads批量进行持久化，这样能使 msg-write-threads 更快的去处理更多的写入请求。基于这样的设计，能对各个阶段不同的线程池做精细化的配置，提升资源利用率和整体的性能。</p><h4 id="rocketmq-1" tabindex="-1">rocketmq <a class="header-anchor" href="#rocketmq-1" aria-hidden="true">#</a></h4><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h5 id="_1-逻辑分区" tabindex="-1">1. 逻辑分区 <a class="header-anchor" href="#_1-逻辑分区" aria-hidden="true">#</a></h5><p>为了提升整体的吞吐量与提供跨副本组的高可用能力，RocketMQ 服务端一般会为单个 Topic 创建多个逻辑分区，即在多个副本组上各自维护部分分区 ( Partition)，我们把它称为队列 (MessageQueue)。同一个副本组上同一个 Topic 的队列数相同并从 0 开始连续编号，不同副本组上的 MessageQueue 数量可以不同。 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 每个Topic在Broker上会划分成几个逻辑队列，每个逻辑队列保存一部分消息数据。从上面模型可以看出，要解决消费并发，就是要利用Queue,一个Topic可以分出更多的queue,每一个queue可以存放在不同的硬件上来提高并发。</p><h5 id="_2-持久化" tabindex="-1">2. 持久化 <a class="header-anchor" href="#_2-持久化" aria-hidden="true">#</a></h5><p>在RocketMQ中消息刷盘主要可以分为同步刷盘和异步刷盘两种。 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 消息写入内存的PAGECACHE后，立刻通知刷盘线程刷盘，然后等待刷盘完成，刷盘线程执行完成后唤醒等待的线程，返回消息写成功的状态。</p><p><div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div> 在返回写成功状态时，消息可能只是被写入了内存的PAGECACHE，写操作的返回快，吞吐量大；当内存里的消息量积累到一定程度时，统一触发写磁盘操作，快速写入。</p><h5 id="_3-消息发送" tabindex="-1">3. 消息发送 <a class="header-anchor" href="#_3-消息发送" aria-hidden="true">#</a></h5><p>三种发送方式：同步/异步/单向</p><p>消息发送的返回状态有如下四种 : FLUSH_DISK_TIMEOUT 、 FLUSH_SLAVE_TIMEOUT 、SLAVE_NOT_AVAILABLE 、SEND_OK，不同状态在不同的刷盘策略和同步策略的配置下含义是不同的 。 <strong>FLUSH_DISK_TIMEOUT</strong> : 表示没有在规定时间内完成刷盘(需要 Broker 的刷盘策被设置成 SYNC_FLUSH 才会报这个错误) 。 <strong>FLUSH_SLAVE_TIMEOUT</strong> :表示在主备方式下，并且 Broker被设 置 成 SYNC_MASTER 方式，没有在设定时间内完成 主从同步 。 <strong>SLAVE_NOT_AVAILABLE</strong> : 这个状态 产生的场景和 FLUSH_SLAVE_TIMEOUT 类似， 表示在主备 方式下，并且 Broker被设置成 SYNC_MASTER，但是没有找到被配置成 Slave 的 Broker。 <strong>SEND_ OK</strong> :表示发送成功，发送成功的具体含义，比如消息是否已经 被存储到融盘?消息是否被同步到了 Slave上?消息在 Slave上是否被 写人磁盘?需要结合所配置的刷盘策略、主从策略来定 。 这个状态还可 以简单理解为，没有发生上面列出的 三个问题状态就是 SEND OK。</p><h5 id="_4-批量生产-消费" tabindex="-1">4. 批量生产/消费 <a class="header-anchor" href="#_4-批量生产-消费" aria-hidden="true">#</a></h5><p>批量消息是指将多条小的消息合并成一个批量消息，一次发送出去。这样的好处是可以减少网络IO，提升吞吐量。 比如说原本我有三条消息,如果三条消息分三次发的话,会走三次网络IO,如果我给三条消息整成一起发送,这样就走一次网络了。 <div class="q-img q-img--menu" style="max-height:400px;" role="img" aria-label><div style="padding-bottom:56.25%;"></div><div class="q-img__content absolute-full q-anchor--skip"></div></div></p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><p>目前团队使用消息队列的典型例子：</p><table><thead><tr><th></th><th>SOFAMQ特性</th><th>Msgbroker特性</th></tr></thead><tbody><tr><td>infosec-&gt;infosectask事件消息</td><td>堆积</td><td></td></tr><tr><td>infosectask-&gt;itask流审消息</td><td>失败重试、堆积</td><td></td></tr><tr><td>infosectask-&gt;infostudio能力异步结果轮询</td><td>延迟消息</td><td></td></tr><tr><td>infosec高保场景接入</td><td></td><td>事务消息、存储高可靠</td></tr><tr><td>infosec事件异步结果</td><td></td><td>异步、解耦、存储高可靠、推模式实时强</td></tr></tbody></table><h2 id="参考文档" tabindex="-1">参考文档 <a class="header-anchor" href="#参考文档" aria-hidden="true">#</a></h2><ul><li>消息队列的消费语义和投递语义：<a href="https://juejin.cn/post/6844903872029278215" target="_blank" rel="noreferrer">https://juejin.cn/post/6844903872029278215</a></li><li>Msgbroker：<a href="https://yuque.antfin.com/middleware/msgbroker/pubsub" target="_blank" rel="noreferrer">https://yuque.antfin.com/middleware/msgbroker/pubsub</a></li><li>SOFAMQ：<a href="https://yuque.antfin.com/middleware/sofamq/common_msg" target="_blank" rel="noreferrer">https://yuque.antfin.com/middleware/sofamq/common_msg</a></li><li>消息幂等：<a href="https://help.aliyun.com/document_detail/177412.html" target="_blank" rel="noreferrer">https://help.aliyun.com/document_detail/177412.html</a></li><li>kafka时间轮：<a href="https://mp.weixin.qq.com/s/l5Kpg45-4MkOq_xfUczPPA" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/l5Kpg45-4MkOq_xfUczPPA</a></li><li>msgbroker 消息轨迹：<a href="https://developer.alipay.com/post/496000358?inviterWorkNo=322773" target="_blank" rel="noreferrer">https://developer.alipay.com/post/496000358?inviterWorkNo=322773</a></li><li>rocketmq延迟消息：<a href="https://mp.weixin.qq.com/s/iZL8M88gF7s5NmW7DYyYDQ" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/iZL8M88gF7s5NmW7DYyYDQ</a></li></ul></div></div><hr class="q-separator q-separator--horizontal" style="" aria-orientation="horizontal"><div class="q-card__actions justify-start q-card__actions--horiz row"><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--rectangle text-blue-6 q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://qr.alipay.com/fkx12630qiigpvf7yb0nd85"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><div>请我喝杯咖啡</div><span class="q-icon on-right" style="font-size:2em;" aria-hidden="true" role="presentation"><svg viewBox="0 0 16 16"><path style="" d="M2.541 0H13.5a2.551 2.551 0 0 1 2.54 2.563v8.297c-.006 0-.531-.046-2.978-.813-.412-.14-.916-.327-1.479-.536-.303-.113-.624-.232-.957-.353a12.98 12.98 0 0 0 1.325-3.373H8.822V4.649h3.831v-.634h-3.83V2.121H7.26c-.274 0-.274.273-.274.273v1.621H3.11v.634h3.875v1.136h-3.2v.634H9.99c-.227.789-.532 1.53-.894 2.202-2.013-.67-4.161-1.212-5.51-.878-.864.214-1.42.597-1.746.998-1.499 1.84-.424 4.633 2.741 4.633 1.872 0 3.675-1.053 5.072-2.787 2.08 1.008 6.37 2.738 6.387 2.745v.105A2.551 2.551 0 0 1 13.5 16H2.541A2.552 2.552 0 0 1 0 13.437V2.563A2.552 2.552 0 0 1 2.541 0ZM2.309 9.27c-1.22 1.073-.49 3.034 1.978 3.034 1.434 0 2.868-.925 3.994-2.406-1.602-.789-2.959-1.353-4.425-1.207-.397.04-1.14.217-1.547.58Z"></path></svg></span></span></a><div class="q-space"></div><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--rectangle text-teal q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://github.com/YangQuan666/yangquan666.github.io/discussions"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><i class="q-icon on-left notranslate material-icons" style="font-size:2em;" aria-hidden="true" role="presentation">question_answer</i><div>给我留言</div></span></a></div></div></div><div class="q-drawer-container"><div class="q-drawer__opener fixed-right" aria-hidden="true"></div><div class="fullscreen q-drawer__backdrop hidden" style="background-color:rgba(0,0,0,0);" aria-hidden="true"></div><aside class="q-drawer q-drawer--right q-drawer--bordered q-layout--prevent-focus fixed q-drawer--on-top q-drawer--mobile q-drawer--top-padding" style="width:300px;transform:translateX(300px);"><div class="q-drawer__content fit scroll"><div class="q-list q-list--padding"><div class="q-item q-item-type row no-wrap" style="" role="listitem"><div class="q-item__section column q-item__section--side justify-center q-item__section--avatar"><i class="q-icon notranslate material-icons" style="" aria-hidden="true" role="presentation">toc</i></div><div class="q-item__section column q-item__section--main justify-center text-h5"> 目录 </div></div><!--[--><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#介绍" id="toc--#介绍"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">介绍</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#术语" id="toc--#术语"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">术语</div></a></li><!--[--><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#基础" id="toc--#术语#基础"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">基础</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#消息类型" id="toc--#术语#消息类型"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">消息类型</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#其他" id="toc--#术语#其他"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">其他</div></a></li><!----></ul><!--]--></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#消费模式" id="toc--#消费模式"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">消费模式</div></a></li><!--[--><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#拉模式" id="toc--#消费模式#拉模式"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">拉模式</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#推模式" id="toc--#消费模式#推模式"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">推模式</div></a></li><!----></ul><!--]--></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#消息队列选型速览" id="toc--#消息队列选型速览"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">消息队列选型速览</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#投递-消费语义" id="toc--#投递-消费语义"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">投递&amp;消费语义</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#功能特性" id="toc--#功能特性"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">功能特性</div></a></li><!--[--><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#事务消息" id="toc--#功能特性#事务消息"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">事务消息</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#延迟消息" id="toc--#功能特性#延迟消息"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">延迟消息</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#稳定性-性能" id="toc--#功能特性#稳定性-性能"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">稳定性&amp;性能</div></a></li><!----></ul><!--]--></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#总结" id="toc--#总结"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">总结</div></a></li><!----></ul><ul><li><a class="q-item q-item-type row no-wrap q-item--dense q-item--clickable q-link cursor-pointer q-focusable q-hoverable" style="border-radius:8px 0 0 8px;" role="listitem" tabindex="0" href="#参考文档" id="toc--#参考文档"><div class="q-focus-helper" tabindex="-1"></div><div class="q-item__section column q-item__section--main justify-center">参考文档</div></a></li><!----></ul><!--]--></div></div></aside></div><!--]--></main></div><footer class="q-footer q-layout__section--marginal absolute-bottom q-footer--bordered bg-dark text-white" style=""><!----><div class="q-toolbar row no-wrap items-center" role="toolbar">Released under the GPL License. <div class="q-space"></div><a class="q-btn q-btn-item non-selectable no-outline q-btn--flat q-btn--rectangle q-btn--actionable q-focusable q-hoverable" style="" tabindex="0" href="https://github.com/YangQuan666/yangquan666.github.io/blob/main/CHANGELOG.md"><span class="q-focus-helper"></span><span class="q-btn__content text-center col items-center q-anchor--skip justify-center row"><span class="block">Release Note</span></span></a><div class="q-badge flex inline items-center no-wrap q-badge--single-line bg-primary" style="" role="status">0.1.0</div></div></footer></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"post_about.md\":\"f092f131\",\"post_usb.md\":\"7e47660a\",\"index.md\":\"b1498770\",\"post_android.md\":\"6481ca6a\",\"post_my-rpc.md\":\"48434547\",\"post_xbox.md\":\"e11cb8e7\",\"post_piano.md\":\"f47bbc05\",\"post_hik-resume.md\":\"e2c76fcc\",\"post_shuangpin.md\":\"abd60f1f\",\"post_message-queue.md\":\"b95ed7fa\",\"post_computer.md\":\"261b3b68\",\"post_great-firewall.md\":\"e122d77d\",\"post_openwrt.md\":\"71c9a62f\",\"post_desk-setup.md\":\"fa973edc\",\"post_java-stream.md\":\"d404e65c\",\"post_infosec.md\":\"efac00fa\",\"post_keyword-check.md\":\"283d5062\"}")</script>
    <script type="module" async src="/assets/app.0503c94e.js"></script>
    
  </body>
</html>