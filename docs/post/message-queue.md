---
title: ä½ çœŸçš„äº†è§£æ¶ˆæ¯é˜Ÿåˆ—å—
date: 2022-11-11
excerpt: "æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§é«˜æ•ˆçš„å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œèƒ½å¤Ÿåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°è§£è€¦ã€å‰Šå³°å¡«è°·å’Œå¯é æ€§ç­‰ä¼˜åŠ¿ã€‚æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ¶ˆæ¯é˜Ÿåˆ—çš„å·¥ä½œåŸç†ã€åº”ç”¨åœºæ™¯ä»¥åŠå¸¸è§çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œä¸ºè¯»è€…æä¾›å…¨é¢çš„äº†è§£å’Œåº”ç”¨æŒ‡å¯¼"
tags:

- mq
- æ¶ˆæ¯é˜Ÿåˆ—
- kafka
- time wheel

---

# ä½ çœŸçš„äº†è§£æ¶ˆæ¯é˜Ÿåˆ—å—

![intro.png](/post/message-queue/intro.png)

## ä»‹ç»

æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é‡è¦çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ä¸šåŠ¡ç³»ç»Ÿè§£æ„æå‡å¼€å‘æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š **å¼‚æ­¥**ï¼Œ**è§£è€¦**ï¼Œ**å‰Šå³°å¡«è°·**ï¼ˆè“„æ´ªï¼‰ã€‚

ä¸æ­¤åŒæ—¶æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯èƒ½å¸¦æ¥å¦‚ä¸‹çš„é—®é¢˜ï¼š **æ•°æ®ä¸¢å¤±**ï¼Œ**æ•°æ®é‡å¤**ï¼Œ**è¿ç»´æˆæœ¬å¢åŠ **

## æœ¯è¯­

### åŸºç¡€

| **ä¸­æ–‡**   | **è‹±æ–‡**          | **é‡Šä¹‰**                                                                          |
| ---------- | ----------------- | --------------------------------------------------------------------------------- |
| æ¶ˆæ¯       | Message           | æ¶ˆæ¯ç³»ç»Ÿä¸­ä¿¡æ¯ä¼ é€’çš„è½½ä½“                                                          |
| æ¶ˆæ¯ä¸»é¢˜   | Topic             | æ¶ˆæ¯ä¸»é¢˜ï¼Œä¸€çº§æ¶ˆæ¯ç±»å‹ï¼Œé€šè¿‡ Topic å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç±»                                 |
| æ¶ˆæ¯æ ‡ç­¾   | Tag               | åŸºäºTopicä¸‹æ›´ç»†ç»´åº¦çš„åŒºåˆ†                                                         |
| åˆ†åŒº       | Queue / Partition | æ¯ä¸ª Topic ä¸‹ä¼šç”±ä¸€åˆ°å¤šä¸ªé˜Ÿåˆ—æ¥å­˜å‚¨æ¶ˆæ¯                                           |
| æ¶ˆæ¯ç”Ÿäº§è€… | Producer          | è´Ÿè´£ç”Ÿäº§å¹¶å‘é€æ¶ˆæ¯                                                                |
| æ¶ˆæ¯æ¶ˆè´¹è€… | Consumer          | è´Ÿè´£æ¶ˆæ¯çš„æ¶ˆè´¹                                                                    |
| æ¶ˆè´¹è€…åˆ†ç»„ | ConsumerGroup     | ç”±ä¸€ç±»Consumerç»„æˆï¼Œå…±åŒæ¶ˆè´¹åŒä¸€ä¸ªTopicçš„æ¶ˆæ¯                                     |
| è®¢é˜…å…³ç³»   | Subscription      | è®¢é˜…å…³ç³»ï¼Œè¡¨ç¤ºConsumerå’ŒTopicçš„æ˜ å°„å…³ç³»ï¼Œæ˜¯æ¶ˆæ¯ä¸­å¿ƒæŠ•é€’æ¶ˆæ¯ç»™ä¸‹æ¸¸æ¶ˆè´¹æ–¹çš„å”¯ä¸€ä¾æ® |

### æ¶ˆæ¯ç±»å‹

| ä¸­æ–‡     | è‹±æ–‡                  | é‡Šä¹‰                                                                                                                                                |
| -------- | --------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| å®šæ—¶æ¶ˆæ¯ | Timer message         | Producer å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç«¯ï¼Œä½†å¹¶ä¸æœŸæœ›è¿™æ¡æ¶ˆæ¯ç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯æ¨è¿Ÿåˆ°åœ¨å½“å‰æ—¶é—´ç‚¹ä¹‹åçš„æŸä¸€ä¸ªæ—¶é—´æŠ•é€’åˆ° Consumer è¿›è¡Œæ¶ˆè´¹ï¼Œè¯¥æ¶ˆæ¯å³å®šæ—¶æ¶ˆæ¯ã€‚ |
| å»¶æ—¶æ¶ˆæ¯ | Delayed message       | Producer å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç«¯ï¼Œä½†å¹¶ä¸æœŸæœ›è¿™æ¡æ¶ˆæ¯ç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰æŠ•é€’åˆ° Consumer è¿›è¡Œæ¶ˆè´¹ï¼Œè¯¥æ¶ˆæ¯å³å»¶æ—¶æ¶ˆæ¯ã€‚                   |
| äº‹åŠ¡æ¶ˆæ¯ | Transactional message | æ¶ˆæ¯é˜Ÿåˆ—æä¾›ç±»ä¼¼ X/Open XA çš„åˆ†å¸ƒäº‹åŠ¡åŠŸèƒ½ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„äº‹åŠ¡æ¶ˆæ¯èƒ½è¾¾åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´ã€‚                                                       |
| é¡ºåºæ¶ˆæ¯ | Ordered message       | æ¶ˆæ¯é˜Ÿåˆ—æä¾›çš„ä¸€ç§æŒ‰ç…§é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹çš„æ¶ˆæ¯ç±»å‹ï¼Œåˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯å’Œåˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼Œå½“å‰ä»…æ”¯æŒåˆ†åŒºé¡ºåºæ¶ˆæ¯ã€‚                                        |

### å…¶ä»–

| ä¸­æ–‡         | è‹±æ–‡                     | é‡Šä¹‰                                                                                                                                                                          |
| ------------ | ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æ¶ˆæ¯å †ç§¯     | Message accumulation     | Producer å·²ç»å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„æœåŠ¡ç«¯ï¼Œä½†ç”±äº Consumer æ¶ˆè´¹èƒ½åŠ›æœ‰é™ï¼Œæœªèƒ½åœ¨çŸ­æ—¶é—´å†…å°†æ‰€æœ‰æ¶ˆæ¯æ­£ç¡®æ¶ˆè´¹æ‰ï¼Œæ­¤æ—¶åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„æœåŠ¡ç«¯ä¿å­˜ç€æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œè¯¥çŠ¶æ€å³æ¶ˆæ¯å †ç§¯ ã€‚  |
| æ¶ˆæ¯è½¨è¿¹     | Message trace            | åœ¨ä¸€æ¡æ¶ˆæ¯ä» Producer å‘å‡ºåˆ° Consumer æ¶ˆè´¹å¤„ç†è¿‡ç¨‹ä¸­ï¼Œç”±å„ä¸ªç›¸å…³èŠ‚ç‚¹çš„æ—¶é—´ã€åœ°ç‚¹ç­‰æ•°æ®æ±‡èšè€Œæˆçš„å®Œæ•´é“¾è·¯ä¿¡æ¯ã€‚                                                                |
| é‡ç½®æ¶ˆè´¹ä½ç‚¹ | Reset consumption offset | ä»¥æ—¶é—´è½´ä¸ºåæ ‡ï¼Œåœ¨æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨çš„æ—¶é—´èŒƒå›´å†…ï¼Œé‡æ–°è®¾ç½® Consumer å¯¹å·²è®¢é˜…çš„ Topic çš„æ¶ˆè´¹è¿›åº¦ï¼Œè®¾ç½®å®Œæˆå Consumer å°†æ¥æ”¶è®¾å®šæ—¶é—´ç‚¹ä¹‹åç”± Producer å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç«¯çš„æ¶ˆæ¯ã€‚ |

## æ¶ˆè´¹æ¨¡å¼

![pull&push.png](/post/message-queue/pull&push.png)

### æ¨æ¨¡å¼ï¼ˆpushï¼‰

**è§£é‡Š**ï¼šå½“ Producer å‘å‡ºçš„æ¶ˆæ¯åˆ°è¾¾åï¼ŒæœåŠ¡ç«¯é©¬ä¸Šå°†è¿™æ¡æ¶ˆæ¯æŠ•é€’ç»™ Consumer

**é€‚ç”¨åœºæ™¯**

1. **æ¶ˆæ¯å®æ—¶æ€§è¦æ±‚è¾ƒé«˜**ï¼šé‡‡ç”¨æ¨æ¨¡å¼ï¼Œæ¶ˆæ¯ä¸€åˆ°brokerå°±ä¼šç«‹åˆ»å‘é€ç»™ Consumerï¼Œè€Œæ‹‰æ¨¡å¼åˆ™éœ€è¦æ¶ˆè´¹è€…ä¸»åŠ¨å»è½®è®­ï¼Œéœ€è¦è‡ªå·±æ§åˆ¶æ—¶é—´é—´éš”
2. **å®ç°ç®€å•**ï¼šæ¶ˆè´¹è€…ä½¿ç”¨æ¥è¯´æ›´ç®€å•ï¼Œå°±ç­‰ç€ï¼Œåæ­£æœ‰æ¶ˆæ¯æ¥äº†å°±ä¼šæ¨è¿‡æ¥

### æ‹‰æ¨¡å¼ï¼ˆpullï¼‰

**è§£é‡Š**ï¼šå½“æœåŠ¡ç«¯æ”¶åˆ°è¿™æ¡æ¶ˆæ¯åä»€ä¹ˆä¹Ÿä¸åšï¼Œåªæ˜¯ç­‰ç€ Consumer ä¸»åŠ¨åˆ°è‡ªå·±è¿™é‡Œæ¥è¯»ï¼Œå³ Consumer è¿™é‡Œæœ‰ä¸€ä¸ª"æ‹‰å–"çš„åŠ¨ä½œ

**é€‚ç”¨åœºæ™¯**

1. **æ¶ˆè´¹é€Ÿç‡å¯æ§**ï¼šé‡‡ç”¨æ‹‰æ¨¡å¼ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¶ˆè´¹é€Ÿç‡ï¼ŒåŠ¨æ€çš„è°ƒæ•´æ‹‰å–çš„é¢‘ç‡ï¼Œå¾ˆéš¾å‡ºç°æ¶ˆæ¯ç§¯å‹
2. **éƒ¨åˆ†æˆ–å…¨éƒ¨ Consumer ä¸åœ¨çº¿**ï¼šå¦‚æœé‡‡ç”¨æ¨æ¨¡å¼ï¼Œå› ä¸ºæ— æ³•é¢„çŸ¥ Consumer çš„å®•æœºæˆ–ä¸‹çº¿æ˜¯çŸ­æš‚çš„è¿˜æ˜¯æŒä¹…çš„ï¼Œå¦‚æœä¸€ç›´ä¸ºè¯¥ Consumer
   ä¿ç•™è‡ªå®•æœºå¼€å§‹çš„æ‰€æœ‰å†å²æ¶ˆæ¯ï¼Œé‚£ä¹ˆå³ä¾¿å…¶ä»–æ‰€æœ‰çš„ Consumer éƒ½å·²ç»æ¶ˆè´¹å®Œæˆï¼Œæ•°æ®ä¹Ÿæ— æ³•æ¸…ç†æ‰ï¼Œéšç€æ—¶é—´çš„ç§¯ç´¯ï¼Œé˜Ÿåˆ—çš„é•¿åº¦ä¼šè¶Šæ¥è¶Šå¤§ï¼Œæ­¤æ—¶æ— è®ºæ¶ˆæ¯æ˜¯æš‚å­˜äºå†…å­˜è¿˜æ˜¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼ˆé‡‡ç”¨
   Push æ¨¡å‹çš„ç³»ç»Ÿï¼Œä¸€èˆ¬éƒ½æ˜¯å°†æ¶ˆæ¯é˜Ÿåˆ—ç»´æŠ¤äºå†…å­˜ä¸­ï¼Œä»¥ä¿è¯æ¨é€çš„æ€§èƒ½å’Œå®æ—¶æ€§ï¼‰ï¼Œéƒ½å°†å¯¹ CMQ æœåŠ¡ç«¯é€ æˆå·¨å¤§å‹åŠ›ï¼Œç”šè‡³å¯èƒ½å½±å“åˆ°å…¶ä»–
   Consumer çš„æ­£å¸¸æ¶ˆè´¹ï¼Œå°¤å…¶å½“æ¶ˆæ¯çš„ç”Ÿäº§é€Ÿç‡éå¸¸å¿«æ—¶æ›´æ˜¯å¦‚æ­¤ï¼›ä½†æ˜¯å¦‚æœä¸ä¿ç•™æ•°æ®ï¼Œé‚£ä¹ˆç­‰è¯¥ Consumer å†æ¬¡èµ·æ¥æ—¶ï¼Œåˆ™è¦é¢å¯¹ä¸¢å¤±æ•°æ®çš„é—®é¢˜ã€‚
   æŠ˜ä¸­çš„æ–¹æ¡ˆæ˜¯ï¼šCMQ ç»™æ•°æ®è®¾å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“ Consumer å®•æœºæ—¶é—´è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œåˆ™æ¸…ç†æ•°æ®ï¼›ä½†è¿™ä¸ªæ—¶é—´é˜ˆå€¼ä¹Ÿå¹¶ä¸å¤ªå®¹æ˜“ç¡®å®šã€‚
   é‡‡ç”¨æ‹‰æ¨¡å¼ï¼Œæƒ…å†µä¼šæœ‰æ‰€æ”¹å–„ï¼›æœåŠ¡ç«¯ä¸å†å…³å¿ƒ Consumer çš„çŠ¶æ€ï¼Œè€Œæ˜¯é‡‡å–â€œä½ æ¥äº†æˆ‘æ‰æœåŠ¡â€çš„æ–¹å¼ï¼ŒConsumer æ˜¯å¦èƒ½å¤ŸåŠæ—¶æ¶ˆè´¹æ•°æ®ï¼ŒæœåŠ¡ç«¯ä¸ä¼šåšä»»ä½•ä¿è¯ï¼ˆä¹Ÿæœ‰è¶…æ—¶æ¸…ç†æ—¶é—´ï¼‰ã€‚


## å¸¸è§MQæ¯”å¯¹

| **åŠŸèƒ½ç‰¹æ€§** | **RocketMQ** | **MsgBrokerï¼ˆèš‚èšå†…éƒ¨ï¼‰** | **Kafka** | **RabbitMQ** |
| ------------ | ------------ | ------------------------- | --------- | ------------ |
| äº‹åŠ¡æ¶ˆæ¯     | âœ…            | âœ…                         | âœ…         | âœ…            |
| å»¶è¿Ÿæ¶ˆæ¯     | âœ…            | âœ…                         | âœ…         | ğŸš«            |
| ä¼˜å…ˆçº§æ¶ˆæ¯   | ğŸš«            | ğŸš«                         | ğŸš«         | âœ…            |
| é¡ºåºæ¶ˆæ¯     | âœ…            | ğŸš«                         | âœ…         | âœ…            |
| æ¶ˆæ¯è½¨è¿¹     | âœ…            | âœ…                         | ğŸš«         | âœ…            |
| æ¶ˆæ¯è¿‡æ»¤     | âœ…            | âœ…                         | ğŸš«         | ğŸš«            |
| æ¶ˆè´¹æ¨¡å¼     | æ‹‰           | æ¨                        | æ‹‰        | æ¨ã€æ‹‰       |
| ç§¯å‹èƒ½åŠ›     | å¼ºï¼ˆäº¿çº§ï¼‰   | å¼±ï¼ˆç™¾ä¸‡çº§ï¼‰              | å¼º        | å¼±           |
| å­˜å‚¨æ¨¡å¼     | ç£ç›˜         | DB                        | ç£ç›˜      | ç£ç›˜         |
| å¯é æ€§       | ä¸­           | é«˜                        | ä¸­        | ä¸­           |

## æŠ•é€’&æ¶ˆè´¹è¯­ä¹‰

### æŠ•é€’è¯­ä¹‰

**æœ€å¤šä¸€æ¬¡**ï¼š`Producer`ä¸ç­‰å¾…`Broker`ç¡®è®¤ï¼Œåªç®¡å‘å‡ºå³å¯ï¼›æœ€å¯èƒ½ä¸¢å¤±æ¶ˆæ¯ã€‚å¦‚æœä¸¢äº†æ¶ˆæ¯ï¼Œå°±æ˜¯æŠ•é€’0æ¬¡ã€‚å¦‚æœæ²¡ä¸¢ï¼Œå°±æ˜¯æŠ•é€’1æ¬¡ã€‚

**æœ€å°‘ä¸€æ¬¡**ï¼š`Producer`å‘é€ç»™`Broker`å¹¶ç­‰å¾…è¿”å›`ACK`ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœæœªæ”¶åˆ°`ACK`ï¼Œåˆ™ä¼šé‡æ–°å‘é€ï¼Œè¿™æ ·å°±ä¼šå‡ºç°å¤§äº1æ¬¡çš„æŠ•é€’æƒ…å†µã€‚

**æ°å¥½ä¸€æ¬¡**ï¼š`Producer`æ¯æ¡æ¶ˆæ¯æœ‰å”¯ä¸€çš„ç¼–å·ï¼Œ`Broker`ä¹Ÿä¼šæ£€æŸ¥`Producer`çš„ç¼–å·ï¼Œå¦‚æœç¼–å·å·²å­˜åœ¨åˆ™ä¼šä¸¢å¼ƒï¼Œå¯ä»¥å®ç°æ°å¥½æŠ•é€’1æ¬¡ã€‚

### æ¶ˆè´¹è¯­ä¹‰

**æœ€å¤šä¸€æ¬¡**ï¼š`Broker`æŠ•é€’å®Œæ¶ˆæ¯å³è®¤ä¸ºæ˜¯æ¶ˆè´¹æˆåŠŸï¼Œæ— éœ€ç­‰å¾…`Comsumer`è¿”å›`ACK`ç¡®è®¤ï¼Œæœ‰å¯èƒ½`Comsumer`æ¶ˆè´¹çš„æ—¶å€™å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå› æ­¤æœ€å¤šæ¶ˆè´¹ä¸€æ¬¡

**æœ€å°‘ä¸€æ¬¡**ï¼š`Broker`æŠ•é€’å®Œæ¶ˆæ¯ä¼šéœ€è¦`Comsumer`è¿”å›`ACK`ç¡®è®¤ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°`ACK`ï¼Œåˆ™ä¼šé‡æ–°å‘é€

**æ°å¥½ä¸€æ¬¡**ï¼š`Broker`æŠ•é€’å®Œæ¶ˆæ¯ä¼šéœ€è¦`Comsumer`è¿”å›`ACK`ç¡®è®¤ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°`ACK`ï¼Œåˆ™ä¼šé‡æ–°å‘é€ï¼ŒåŒæ—¶`Comsumer`éœ€è¦å®ç°å¹‚ç­‰é€»è¾‘ï¼Œä¿è¯æ¶ˆæ¯ä¸é‡å¤æ¶ˆè´¹


## åŠŸèƒ½ç‰¹æ€§

### äº‹åŠ¡æ¶ˆæ¯

> ä»¥RocketMQä¸ºä¾‹

#### ä½¿ç”¨åœºæ™¯

ç”¨æˆ·å‘èµ·è®¢å•ï¼Œæ”¯ä»˜100å—é’±æ“ä½œå®Œæˆåï¼Œèƒ½å¾—åˆ°100ç§¯åˆ†ï¼Œè´¦æˆ·æœåŠ¡å’Œä¼šå‘˜æœåŠ¡æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡æ¨¡å—ï¼Œæœ‰å„è‡ªçš„æ•°æ®åº“ï¼ŒæŒ‰ç…§ä¸Šæ–‡æåŠçš„é—®é¢˜å¯èƒ½æ€§ï¼Œå°†ä¼šå‡ºç°è¿™äº›æƒ…å†µï¼š

- å¦‚æœå…ˆæ‰£æ¬¾ï¼Œå†å‘æ¶ˆæ¯ï¼Œå¯èƒ½é’±åˆšæ‰£å®Œï¼Œæ¶ˆæ¯æ²¡å‘å¤±è´¥äº†ï¼Œç»“æœç§¯åˆ†æ²¡å¢åŠ ã€‚
- å¦‚æœå…ˆå‘æ¶ˆæ¯ï¼Œå†æ‰£æ¬¾ï¼Œå¯èƒ½ç§¯åˆ†å¢åŠ äº†ï¼Œä½†é’±æ²¡æ‰£æ‰ï¼Œç™½é€äº†100ç§¯åˆ†
- é’±æ­£å¸¸æ‰£äº†ï¼Œæ¶ˆæ¯ä¹Ÿå‘é€æˆåŠŸäº†ï¼Œä½†ä¼šå‘˜æœåŠ¡å®ä¾‹æ¶ˆè´¹æ¶ˆæ¯å‡ºç°é—®é¢˜ï¼Œç»“æœç§¯åˆ†æ²¡å¢åŠ 

**äº‹åŠ¡æ¶ˆæ¯å°±æ˜¯ä¿è¯æœ¬åœ°äº‹åŠ¡æ“ä½œå’Œmqæ¶ˆæ¯çš„å‘é€æ˜¯ä¸€è‡´çš„ï¼Œå³æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œæ¶ˆæ¯ä¸€å®šå‘é€å‡ºå»ï¼Œæœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œæ¶ˆæ¯ä¸€å®šæœªè¢«æ¶ˆè´¹**

##### æ•´ä½“æµç¨‹

![shiwu.png](/post/message-queue/shiwu.png)

##### å¼‚å¸¸æƒ…å†µ

1. `Producer`å‘é€åŠæ¶ˆæ¯å¤±è´¥
   
   å¯èƒ½ç”±äºç½‘ç»œæˆ–è€…mqæ•…éšœï¼Œå¯¼è‡´`Producer`å‘é€åŠæ¶ˆæ¯(prepare)å¤±è´¥ï¼Œè¿™æ—¶å€™`Producer`ç›´æ¥å›æ»šæœ¬åœ°äº‹åŠ¡å°±å¯ä»¥äº†

2. åŠæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥
   
   å‘é€æ–¹æ‰§è¡Œ`rollback`ç»™`MQ`ï¼Œ`MQ`ä¼šåˆ é™¤ä¹‹å‰å‘é€çš„åŠæ¶ˆæ¯ï¼Œæ¶ˆè´¹ç«¯ä¹Ÿå°±æ”¶ä¸åˆ°è¿™æ¡æ¶ˆæ¯

3. åŠæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæœ¬åœ°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹å®•æœº
   
   `Broker`ä¸€ç›´æ¥å—ä¸åˆ°`Producer`çš„ç¡®è®¤ç»“æœï¼Œå› æ­¤å°±ä¼šè°ƒ`Producer`æä¾›çš„æŸ¥è¯¢æ¥å£æ¥åˆ¤æ–­æœ¬åœ°äº‹åŠ¡çš„æœ€ç»ˆæ‰§è¡Œç»“æœ

**æ€è€ƒ1**ï¼š äº‹åŠ¡å›æŸ¥æ—¶ï¼Œä¸šåŠ¡é€»è¾‘éƒ½éœ€è¦åšäº›ä»€ä¹ˆï¼Ÿ

::: details ç­”æ¡ˆ
äº‹åŠ¡æ¶ˆæ¯çš„ Check æ–¹æ³•é‡Œé¢ï¼Œåº”è¯¥å†™ä¸€äº›æ£€æŸ¥äº‹åŠ¡ä¸€è‡´æ€§çš„é€»è¾‘ã€‚æ¶ˆæ¯é˜Ÿåˆ—å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶éœ€è¦å®ç°`LocalTransactionChecker`æ¥å£ï¼Œç”¨æ¥å¤„ç†`Broker`ä¸»åŠ¨å‘èµ·çš„æœ¬åœ°äº‹åŠ¡çŠ¶æ€å›æŸ¥è¯·æ±‚ï¼›å› æ­¤éœ€è¦å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š

1. æ£€æŸ¥è¯¥åŠäº‹åŠ¡æ¶ˆæ¯å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€ï¼ˆcommitted or rollbackï¼‰ã€‚
2. å‘ Broker æäº¤è¯¥åŠäº‹åŠ¡æ¶ˆæ¯æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€ã€‚
:::

**æ€è€ƒ2**ï¼š `RocketMQ`æ˜¯æ€ä¹ˆä¿è¯åŠæ¶ˆæ¯(prepare)ä¸è¢«æ¶ˆè´¹è€…æ¶ˆè´¹å‘¢ï¼Ÿ
::: details ç­”æ¡ˆ

1. `Broker`ç«¯æ”¶åˆ°æ¶ˆæ¯åï¼Œæ ¹æ®`TRAN_MSG`å€¼åˆ¤æ–­æ˜¯å¦äº‹åŠ¡æ¶ˆæ¯ã€‚åˆ™å°†æ¶ˆæ¯è½¬å­˜åˆ°`topic: RMQ_SYS_TRANS_HALF_TOPIC`ï¼Œ`queueId: 0`
2. å¦‚æœæœ¬åœ°äº‹åŠ¡çŠ¶æ€æ˜¯`commit`ï¼Œ`Broker`æ¢å¤åŸ `topic`ï¼Œ`queueId`, `Consumer`å¯ä»¥æ­£å¸¸æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯
3. å¦‚æœæœ¬åœ°äº‹åŠ¡çŠ¶æ€æ˜¯`rollback`ï¼ŒæŠŠæ¶ˆæ¯æ”¾å…¥`RMQ_SYS_TRANS_OP_HALF_TOPIC` å¹¶é€šè¿‡è®¾ç½®`tags = d`æ ‡è¯†è¯¥æ¶ˆæ¯å·²è¢«åˆ é™¤
:::

### å»¶è¿Ÿæ¶ˆæ¯

ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•æœªä»˜æ¬¾ï¼Œ30åˆ†é’Ÿåéœ€è¦å…³é—­è®¢å•

å¸¸è§åšæ³•ï¼šä½¿ç”¨`redis`çš„`zset`é›†åˆï¼Œå°†å»¶è¿Ÿä»»åŠ¡æŒ‰ç…§è¿‡æœŸæ—¶é—´æ’åºï¼Œç„¶åå®šæ—¶å™¨ä¸æ–­çš„å»è½®è®­
ä¼˜ç‚¹ï¼šç®€å•æ–¹ä¾¿
ç¼ºç‚¹ï¼šå ç”¨çš„å­˜å‚¨ç©ºé—´è¾ƒå¤§ï¼Œå®šæ—¶è½®è¯¢ä¼šé€ æˆä¸å¿…è¦çš„è¯·æ±‚

é—®ï¼šç›´æ¥ç”¨`DelayQueue`æ€ä¹ˆæ ·ï¼Ÿ
ç­”ï¼š`DelayQueue`æ˜¯`JDK`æä¾›çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¯¹äºæœ‰å»¶è¿Ÿéœ€æ±‚çš„åœºæ™¯ï¼Œç›´æ¥ç”¨`DelayQueue`æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸æ”¯æŒå¯¹å»¶è¿Ÿä»»åŠ¡è¿›è¡Œä¿®æ”¹æˆ–åˆ é™¤æ“ä½œï¼ŒåŒæ—¶å¦‚æœä»»åŠ¡è¿‡å¤šï¼Œä¼šé€ æˆ`DelayQueue`ç©ºé—´å ç”¨è¿‡å¤§

#### Kafkaæ—¶é—´è½®

1. `Kafka`ä¸­ä¸€ä¸ªæ—¶é—´è½®(TimingWheel)é»˜è®¤æ˜¯ç”±20ä¸ªæ—¶é—´æ ¼ç»„æˆï¼Œæ¯æ ¼çš„æ—¶é—´è·¨åº¦æ˜¯`1ms`ï¼Œæ—¶é—´è½®åº•å±‚é‡‡ç”¨æ•°ç»„å®ç°ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å¯ä»¥å­˜æ”¾ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åˆ—è¡¨ï¼ˆTimerTaskListï¼‰ã€‚`TimerTaskList`æ˜¯ä¸€ä¸ªç¯å½¢çš„åŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸€é¡¹è¡¨ç¤ºçš„éƒ½æ˜¯å®šæ—¶ä»»åŠ¡é¡¹ï¼ˆTimerTaskEntryï¼‰ï¼Œå…¶ä¸­å°è£…äº†çœŸæ­£çš„å®šæ—¶ä»»åŠ¡`TimerTask`
   ![shijianlun1.png](/post/message-queue/shijianlun1.png)

2. å‡è®¾åˆå§‹çš„æ—¶å€™ä¸€ä¸ªæ ¼å­ä¸€ç§’ï¼Œæ—¶é—´è½®çš„æŒ‡é’ˆå®šæ ¼åœ¨`0`ã€‚æ­¤æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ä¸º`2ms`çš„ä»»åŠ¡, é‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°†ä¼šæ’å…¥åˆ°ç¬¬äºŒä¸ªæ—¶é—´æ ¼ä¸­
   ![shijianlun2.gif](/post/message-queue/shijianlun2.gif)

3. æ—¶é—´è½®çš„æŒ‡é’ˆåˆ°è¾¾ç¬¬äºŒä¸ªæ—¶é—´æ ¼æ—¶, ä¼šå¤„ç†è¯¥æ—¶é—´æ ¼ä¸Šå¯¹åº”çš„ä»»åŠ¡
   ![shijianlun3.gif](/post/message-queue/shijianlun3.gif)

4. å¦‚æœè¿™ä¸ªæ—¶å€™åˆæ’å…¥ä¸€ä¸ªå»¶æ—¶æ—¶é—´ä¸º`8ms`çš„ä»»åŠ¡è¿›æ¥, è¿™ä¸ªä»»åŠ¡çš„è¿‡æœŸæ—¶é—´å°±æ˜¯åœ¨å½“å‰æ—¶é—´`2ms`çš„åŸºç¡€ä¸ŠåŠ `8ms`, ä¹Ÿå°±æ˜¯`10ms`, é‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°†ä¼šæ’å…¥åˆ°è¿‡æœŸæ—¶é—´ä¸º`10ms`çš„æ—¶é—´æ ¼ä¸­ã€‚
   ![shijianlun4.gif](/post/message-queue/shijianlun4.gif)

5. å¦‚æœåœ¨å½“å‰æ—¶é—´æ˜¯`2ms`çš„æ—¶å€™, æ’å…¥ä¸€ä¸ªå»¶æ—¶æ—¶é—´ä¸º`19ms`çš„ä»»åŠ¡æ—¶, è¿™ä¸ªä»»åŠ¡çš„è¿‡æœŸæ—¶é—´å°±æ˜¯åœ¨å½“å‰æ—¶é—´`2ms`çš„åŸºç¡€ä¸ŠåŠ `19ms`,
   ä¹Ÿå°±æ˜¯`21ms`ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±ä¼šæ’å…¥åˆ°è¿‡æœŸæ—¶é—´ä¸º`21ms`çš„æ—¶é—´æ ¼ä¸­
   ![shijianlun5.gif](/post/message-queue/shijianlun5.gif)

6. å¦‚æœåœ¨å½“å‰æ—¶é—´æ˜¯`2ms`çš„æ—¶å€™, æ’å…¥ä¸€ä¸ªå»¶æ—¶æ—¶é—´ä¸º`22ms`çš„ä»»åŠ¡, è¿™ä¸ªä»»åŠ¡çš„è¿‡æœŸæ—¶é—´å°±æ˜¯åœ¨`2ms`çš„åŸºç¡€ä¸ŠåŠ `22ms`ï¼Œä¹Ÿå°±æ˜¯`24ms`ï¼Œä½†æ˜¯æ˜¾ç„¶æ²¡æœ‰`24ms`çš„æ ¼å­
   ![shijianlun6.png](/post/message-queue/shijianlun6.png)

7. ç¬¬ä¸€å±‚çš„æ—¶é—´è½®è£…ä¸ä¸‹çš„æ—¶å€™ï¼Œä»»åŠ¡å°±ä¼šæ”¾å…¥ç¬¬äºŒå±‚çš„æ—¶é—´è½®æ ¼å­ä¸­
   ![shijianlun7.gif](/post/message-queue/shijianlun7.gif)

8. å½“ç¬¬äºŒå±‚æ—¶é—´è½®ä¸Šçš„ä»»åŠ¡åˆ°æœŸåï¼Œå°±ä¼šæ‰§è¡Œæ—¶é—´è½®çš„é™çº§ï¼ŒåŸæœ¬è¶…æ—¶æ—¶é—´ä¸º`24ms`çš„ä»»åŠ¡ä¼šè¢«ä»ç¬¬äºŒå±‚å–å‡ºæ¥ï¼Œæ”¾å…¥ç¬¬ä¸€å±‚åˆ°æœŸæ—¶é—´ä¸º`24ms`çš„æ ¼å­ä¸­
   ![shijianlun8.gif](/post/message-queue/shijianlun8.gif)

9. ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºæ—¶é—´è½®çš„å·§å¦™ä¹‹å¤„ï¼Œä¸¤å±‚æ—¶é—´è½®åªç”¨äº†`40`ä¸ªæ•°ç»„å…ƒç´ ï¼Œå´å¯ä»¥æ‰¿è½½`[0-399s]`çš„å®šæ—¶ä»»åŠ¡ã€‚è€Œä¸‰å±‚æ—¶é—´è½®ç”¨`60`ä¸ªæ•°ç»„å…ƒç´ ï¼Œå°±å¯ä»¥æ‰¿è½½`[0-7999s]`çš„å®šæ—¶ä»»åŠ¡
   ![shijianlun9.png](/post/message-queue/shijianlun9.png)

**æ€»ç»“**

- Kafka ä½¿ç”¨æ—¶é—´è½®æ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ï¼Œå› ä¸ºå…¶åº•å±‚æ˜¯ä»»åŠ¡çš„æ·»åŠ å’Œåˆ é™¤æ˜¯åŸºäºé“¾è¡¨å®ç°çš„ï¼Œæ˜¯ O(1) çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ»¡è¶³é«˜æ€§èƒ½çš„è¦æ±‚
- DelayQueue åªå­˜æ”¾äº† TimerTaskListï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ TimerTaskï¼Œæ•°é‡å¹¶ä¸å¤šï¼Œç›¸æ¯”ç©ºæ¨è¿›å¸¦æ¥çš„å½±å“æ˜¯åˆ©å¤§äºå¼Šçš„
- å¯¹äºæ—¶é—´è·¨åº¦å¤§çš„å»¶æ—¶ä»»åŠ¡ï¼ŒKafka å¼•å…¥äº†å±‚çº§æ—¶é—´è½®ï¼Œèƒ½æ›´å¥½æ§åˆ¶æ—¶é—´ç²’åº¦ï¼Œå¯ä»¥åº”å¯¹æ›´åŠ å¤æ‚çš„å®šæ—¶ä»»åŠ¡å¤„ç†åœºæ™¯

**æ€è€ƒ**ï¼š æ’å…¥ä¸€ä¸ªå»¶æ—¶æ—¶é—´`400ms`çš„ä»»åŠ¡, æŒ‡é’ˆå°±è¦æ‰§è¡Œ`399`æ¬¡"ç©ºæ¨è¿›"å—ï¼Ÿ
::: details ç­”æ¡ˆ
    Kafkaé€šè¿‡ä¸€ä¸ª`DelayQueue`ä¿å­˜äº†æ‰€æœ‰çš„`TimerTaskList`å¯¹è±¡ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå«åš`ExpiredOperationReaper`çš„çº¿ç¨‹ä» `DelayQueue`
    ä¸­è·å–è¶…æ—¶çš„ä»»åŠ¡åˆ—è¡¨ `TimerTaskList`ï¼Œç„¶åæ ¹æ®`TimerTaskList` çš„è¿‡æœŸæ—¶é—´æ¥ç²¾ç¡®æ¨è¿›æ—¶é—´è½®çš„æ—¶é—´ï¼Œè¿™æ ·å°±ä¸ä¼šå­˜åœ¨ç©ºæ¨è¿›çš„é—®é¢˜ï¼Œ
:::

#### rocketmqå†…éƒ¨ç‰ˆ

rocketmqåœ¨kafkaçš„æ—¶é—´è½®åŸºç¡€ä¸Šæä¾›äº†å»¶è¿Ÿæ¶ˆæ¯å¯é çš„å­˜å‚¨æ–¹å¼

1. æ—¶é—´è½®çš„æ¯ä¸€æ ¼è®¾è®¡å¦‚ä¸‹

   | delay_time(8B) å»¶è¿Ÿæ—¶é—´ | first_pos é¦–æ¡ä½ç½® | last_pos(8B) æœ€åä½ç½® | num(4B) æ¶ˆæ¯æ¡æ•° |
   | ----------------------- | ------------------ | --------------------- | ---------------- |

2. `TimerLog`ï¼šå®šæ—¶æ¶ˆæ¯çš„è®°å½•æ–‡ä»¶ï¼ŒAppend Onlyã€‚æ¯æ¡è®°å½•åŒ…å«ä¸€ä¸ª`prev_pos`ï¼ŒæŒ‡å‘å‰ä¸€æ¡å®šæ—¶åˆ°åŒæ ·æ—¶åˆ»çš„è®°å½•
3. `TimerLog`ä¸`TimerWheel`çš„åä½œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
   ![r_shijianlun1.png](/post/message-queue/r_shijianlun1.png)

##### å·¥ä½œæµç¨‹

![r_shijianlun1.png](/post/message-queue/r_shijianlun1.png)

1. é’ˆå¯¹æ”¾ç½®å®šæ—¶æ¶ˆæ¯çš„`service`ï¼Œæ¯`50ms`ä»`commitLog`è¯»å–æŒ‡å®š`topic`çš„å®šæ—¶æ¶ˆæ¯
   1. `TimerEnqueueGetService`ä»`commitLog`è¯»å–å¾—åˆ°å®šæ—¶ä¸»é¢˜çš„æ¶ˆæ¯ï¼Œå¹¶å…ˆå°†å…¶æ”¾å…¥`enqueuePutQueue`
   2. å¦ä¸€ä¸ªçº¿ç¨‹`TimerEnqueuePutService`å°†å…¶æ”¾å…¥`timerLog`ï¼Œæ›´æ–°æ—¶é—´è½®çš„å­˜å‚¨å†…å®¹ã€‚å°†è¯¥ä»»åŠ¡æ”¾è¿›æ—¶é—´è½®çš„æŒ‡å®šä½ç½®
2. é’ˆå¯¹å–å‡ºå®šæ—¶æ¶ˆæ¯çš„`service`ï¼Œæ¯`50ms`è¯»å–ä¸‹ä¸€ç§’çš„`slot`ã€‚æœ‰ä¸‰ä¸ªçº¿ç¨‹å°†è¯»å–åˆ°çš„æ¶ˆæ¯é‡æ–°æ”¾å›`commitLog`
   1. é¦–å…ˆï¼Œ`TimerDequeueGetService`æ¯`50ms`è¯»å–ä¸‹ä¸€ç§’çš„`slot`ï¼Œä»`timerLog`ä¸­å¾—åˆ°æŒ‡å®šçš„`msgs`ï¼Œå¹¶æ”¾è¿›`dequeueGetQueue`
   2. è€Œå`TimerDequeueGetMessageService`ä»`dequeueGetQueue`ä¸­å–å‡º`msg`ï¼Œå¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚è¯¥é˜Ÿåˆ—ä¸ºå¾…å†™å…¥`commitLog`çš„é˜Ÿåˆ—`dequeuePutQueue`
   3. æœ€å`TimerDequeuePutMessageService`å°†è¿™ä¸ª`queue`ä¸­çš„æ¶ˆæ¯å–å‡ºï¼Œè‹¥å·²åˆ°æœŸåˆ™ä¿®æ”¹`topic`ï¼Œæ”¾å›`commitlog`ï¼Œå¦åˆ™ç»§ç»­æŒ‰åŸ`topic`å†™å›`commitLog`æ»šåŠ¨æ—¥å¿—

ç¼ºç‚¹
- åªèƒ½ç²¾ç¡®åˆ°ç§’çº§
- é¡ºåºçš„å†™ä¼šå¸¦æ¥éšæœºçš„è¯»ï¼Œå¯¼è‡´è¯»å–æ€§èƒ½è¾ƒä½

#### rocketmqç¤¾åŒºç‰ˆ

RocketMQç¤¾åŒºç‰ˆæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†æ˜¯ä¸æ”¯æŒä»»æ„æ—¶é—´ç²¾åº¦çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œåªæ”¯æŒç‰¹å®šçº§åˆ«çš„å»¶è¿Ÿæ¶ˆæ¯
æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«åˆ†åˆ«ä¸º`1s`, `5s`, `10s`, `30s`, `1min`, `2min`, `3min`, `4min`, `5min`, `6min`, `7min`, `8min`, `9min`, `10min`, `20min`, `30min`, `1h`, `2h` å…±18ä¸ªçº§åˆ«ã€‚åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å³å¯ï¼Œè®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«æ—¶æœ‰ä»¥ä¸‹3ç§æƒ…å†µï¼š

1. è®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ç­‰äº0æ—¶ï¼Œåˆ™è¯¥æ¶ˆæ¯ä¸ºéå»¶è¿Ÿæ¶ˆæ¯ã€‚
2. è®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å¤§äºç­‰äº1å¹¶ä¸”å°äºç­‰äº18æ—¶ï¼Œæ¶ˆæ¯å»¶è¿Ÿç‰¹å®šæ—¶é—´ï¼Œå¦‚ï¼šè®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ç­‰äº1ï¼Œåˆ™å»¶è¿Ÿ1sï¼›è®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ç­‰äº2ï¼Œåˆ™å»¶è¿Ÿ5sï¼Œä»¥æ­¤ç±»æ¨ã€‚
3. è®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«å¤§äº18æ—¶ï¼Œåˆ™è¯¥æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ä¸º18ï¼Œå¦‚ï¼šè®¾ç½®æ¶ˆæ¯å»¶è¿Ÿçº§åˆ«ç­‰äº20ï¼Œåˆ™å»¶è¿Ÿ2hã€‚

**åŸç†**
RocketMQå‘é€å»¶æ—¶æ¶ˆæ¯æ—¶å…ˆæŠŠæ¶ˆæ¯æŒ‰ç…§å»¶è¿Ÿæ—¶é—´æ®µå‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå®šæ—¶å™¨è¿›è¡Œè½®è®­è¿™äº›é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹æ¶ˆæ¯æ˜¯å¦åˆ°æœŸï¼Œå¦‚æœåˆ°æœŸå°±æŠŠè¿™ä¸ªæ¶ˆæ¯å‘é€åˆ°æŒ‡å®štopicçš„é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åŒä¸€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å»¶æ—¶æ—¶é—´æ˜¯ä¸€è‡´çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ—¶æŒ‰ç…§æ¶ˆæ¯åˆ°æœŸæ—¶é—´è¿›è¡Œé€’å¢æ’åºçš„ï¼Œè¯´çš„ç®€å•ç›´ç™½å°±æ˜¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯è¶Šé å‰çš„åˆ°æœŸæ—¶é—´è¶Šæ—©ã€‚

### é¡ºåºæ¶ˆæ¯

> ä»¥Kafkaä¸ºä¾‹

`Kafka`é€šè¿‡`key`ï¼Œå°†æŸç±»æ¶ˆæ¯å†™å…¥åŒä¸€ä¸ª`partition`ï¼Œä¸€ä¸ª`partition`åªèƒ½å¯¹åº”ä¸€ä¸ª`Consumer`ï¼Œä»¥ä¿è¯æ•°æ®æœ‰åºã€‚

**æ€è€ƒ1**ï¼š`Producer`å…ˆåä¸¤æ¡æ¶ˆæ¯å‘é€æ—¶ï¼Œå‰ä¸€æ¡æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œç„¶åå¤±è´¥çš„æ¶ˆæ¯é‡è¯•åå‘é€æˆåŠŸï¼Œä¼šä¸ä¼šé€ æˆæ¶ˆæ¯ä¹±åºï¼Ÿ

::: details ç­”æ¡ˆ1
ä¸ºäº†è§£å†³é‡è¯•æœºåˆ¶å¼•èµ·çš„æ¶ˆæ¯ä¹±åºï¼Œ`Kafka`å¼•å…¥äº†`Producer ID`ï¼ˆå³PIDï¼‰å’Œ `Sequence Number`

- åœ¨`Producer`ç«¯ï¼Œæ¯ä¸ª`Producer`éƒ½è¢«`Broker`è‡ªåŠ¨åˆ†é…äº†ä¸€ä¸ª`PID`ï¼Œ`Producer`å‘`Broker`å‘é€çš„æ¯æ¡æ¶ˆæ¯ï¼Œåœ¨å†…éƒ¨éƒ½é™„å¸¦ç€è¯¥`PID`å’Œä¸€ä¸ªé€’å¢çš„`Sequence Number`
- åœ¨`Broker`ç«¯ï¼Œä¸ºæ¯ä¸ª`Topic`çš„æ¯ä¸ª`Partition`éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå½“å‰å†™æˆåŠŸçš„æ¶ˆæ¯çš„æœ€å¤§`<PID, Sequence Number>`å…ƒç»„ï¼Œå¦‚æœ`Sequence Number`æ¯”`Broker`ç»´æŠ¤çš„åºå·å·®å€¼å¤§äº`1`ï¼Œè¯´æ˜ä¸­é—´æœ‰æ•°æ®å°šæœªå†™å…¥ï¼Œå³ä¹±åºï¼Œæ­¤æ—¶`Broker`æ‹’ç»è¯¥æ¶ˆæ¯ï¼Œå¦‚æœ`Sequence Number`å°äºç­‰äº`Broker`ç»´æŠ¤çš„åºå·ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯å·²è¢«ä¿å­˜ï¼Œå³ä¸ºé‡å¤æ¶ˆæ¯ï¼Œ`Broker`ç›´æ¥ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«å‘é€åˆ°`Broker`
:::


**æ€è€ƒ2**ï¼šåªæœ‰ä¸€ä¸ª`Partition`ä¼šå¯¼è‡´æ¶ˆè´¹è€…çš„ååé‡å˜ä½ï¼Œå¦‚æœæ¶ˆè´¹è€…å¯ç”¨å¤šçº¿ç¨‹æ¶ˆè´¹ï¼Œåˆ™æ¶ˆæ¯é‡æ–°å˜å¾—æ— åºï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

::: details ç­”æ¡ˆ2
ç­”ï¼šæ¶ˆè´¹è€…ç«¯åˆ›å»ºå¤šä¸ªå†…å­˜é˜Ÿåˆ—ï¼Œå…·æœ‰ç›¸åŒ`key`çš„æ•°æ®éƒ½è·¯ç”±åˆ°åŒä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ï¼›ç„¶åæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—å³å¯ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¤šä¸ªé¡ºåºçš„åŒæ—¶å°½å¯èƒ½æé«˜ååé‡
![shunxu.png](/post/message-queue/shunxu.png)
:::

### æ¶ˆæ¯è½¨è¿¹

> ä»¥èš‚èšçš„MagBrokerä¸ºä¾‹

ä¸€æ¡æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸåŒ…å«å¤šä¸ªé˜¶æ®µï¼šå‘é€ç«¯å‘é€ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯ã€å†™å…¥æ¶ˆæ¯ã€æŠ•é€’æ¶ˆæ¯ç­‰ã€‚è€Œç”¨æˆ·åœ¨ä½¿ç”¨MQæ—¶ï¼Œæœ‰æ—¶ä¼šæƒ³çŸ¥é“æ¶ˆæ¯çš„å‘é€ã€æŠ•é€’ã€æ¶ˆè´¹æƒ…å†µï¼Œä»¥åŠæ¶ˆè´¹è€—æ—¶ã€æ¶ˆè´¹èŠ‚ç‚¹ã€æ˜¯å¦é‡æŠ•ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯éƒ½å±äºæ¶ˆæ¯è½¨è¿¹ã€‚
åœ¨æ²¡æœ‰å¯è§†åŒ–çš„æ¶ˆæ¯è½¨è¿¹ç•Œé¢æ—¶ï¼Œè½¨è¿¹ä¿¡æ¯éƒ½æ˜¯é€šè¿‡åŸå§‹çš„ç¿»æ—¥å¿—çš„æ–¹å¼æ¥æŸ¥è¯¢ã€‚éœ€è¦æ ¹æ®æœºå™¨èŠ‚ç‚¹çš„æ—¥å¿—ä¿¡æ¯æ‰¾åˆ°é“¾è·¯ï¼Œä¸€æ­¥ä¸€æ­¥æº¯æºæŸ¥æ‰¾ã€‚

![guiji.png](/post/message-queue/guiji.png)

è½¨è¿¹æ•°æ®å’Œæ¶ˆæ¯æ•°æ®ä¸åŒã€‚æ¶ˆæ¯ä¸èƒ½ä¸¢å¤±ï¼Œè¦ä¿è¯é«˜å¯é æ€§ï¼Œè€Œè½¨è¿¹ä¿¡æ¯ä¸€èˆ¬åˆ™ç”¨äºé—®é¢˜çš„æ’æŸ¥ï¼Œå¹¶ä¸”å¾€å¾€æ˜¯å†™è¿œå¤§äºè¯»ï¼Œå› æ­¤åœ¨è½¨è¿¹åŠŸèƒ½çš„è®¾è®¡ä¸Šä¸ä»…è¦è€ƒè™‘æˆæœ¬ï¼Œè¿˜è¦è€ƒè™‘å¯¹æ¶ˆæ¯é“¾è·¯æ˜¯å¦æœ‰å½±å“ã€‚å› æ­¤é‡‡ç”¨äº†ç‹¬ç«‹é›†ç¾¤å­˜å‚¨è½¨è¿¹ä¿¡æ¯ï¼ˆPSï¼šå›¾ä¸­çš„`AntKV`å¯ä»¥ç†è§£ä¸º`HBase`ï¼‰

#### è½¨è¿¹å†™å…¥

MsgBrokeræ¶ˆæ¯æœåŠ¡ç«¯åœ¨å¤„ç†æ¶ˆæ¯æ—¶ä¼šè¿›è¡ŒåŸ‹ç‚¹ï¼Œè½¨è¿¹æ•°æ®å°±åœ¨åŸ‹ç‚¹æ—¶äº§ç”Ÿï¼Œå¤„ç†æ¶ˆæ¯ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š
1. æ¶ˆæ¯å­˜å‚¨DBæ—¶
2. æ¶ˆæ¯çš„æ¶ˆè´¹ç»“æœå›è°ƒ
3. äº‹åŠ¡æ¶ˆæ¯çš„æäº¤/å›æ»š
4. å®šæ—¶æ¶ˆæ¯çš„è§¦å‘/ä¿®æ”¹/åˆ é™¤

è½¨è¿¹æ•°æ®ç”Ÿäº§å¥½ä»¥åä¼šè¢«æ¨å…¥è‡³é˜Ÿåˆ—å½“ä¸­ã€‚çº¿ç¨‹å®šæ—¶æå–æ”¶é›†è½¨è¿¹æ•°æ®ï¼Œå¤„ç†ç»„è£…åå‘é€ç»™è½¨è¿¹é›†ç¾¤æœåŠ¡ã€‚è½¨è¿¹æ•°æ®ä¼šä»¥æ¶ˆæ¯çš„å½¢å¼ä»MsgBrokerå‘é€è‡³è½¨è¿¹é›†ç¾¤æœåŠ¡ï¼Œè½¨è¿¹é›†ç¾¤æœåŠ¡æ”¶åˆ°å‘é€çš„è½¨è¿¹æ•°æ®æ—¶ä¼šè¿›è¡Œå­˜å‚¨ã€‚

![guiji1.png](/post/message-queue/guiji1.png)

#### è¯»å–è½¨è¿¹

å½“ç”¨æˆ·ç™»å½•æ¶ˆæ¯æ§åˆ¶å°åˆ›å»ºæŸ¥è¯¢ä»»åŠ¡ï¼Œæ¶ˆæ¯æ§åˆ¶å°ä¼šå‘è½¨è¿¹é›†ç¾¤å†…çš„å„ä¸ªæœåŠ¡å‘é€è¯·æ±‚ï¼Œè½¨è¿¹æ•°æ®å­˜å‚¨åœ¨è½¨è¿¹é›†ç¾¤ä¸‹å„æœåŠ¡çš„æœ¬åœ°`AntKV`ä¸­ã€‚å› ä¸ºæ¶ˆæ¯æœåŠ¡å‘é€è½¨è¿¹ä¿¡æ¯æ¶ˆæ¯è‡³è½¨è¿¹æœåŠ¡æ—¶çš„èŠ‚ç‚¹é€‰å–æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æ•°æ®ä¼šæ•£è½åœ¨é›†ç¾¤å†…å„æœåŠ¡ä¸Šã€‚å› æ­¤æ§åˆ¶å°æœåŠ¡åœ¨æŸ¥è¯¢è½¨è¿¹æ—¶éœ€è¦éå†è½¨è¿¹é›†ç¾¤ä¸‹çš„æ‰€æœ‰è½¨è¿¹æœåŠ¡ï¼Œæ‰èƒ½è·å¾—å®Œæ•´çš„è½¨è¿¹ä¿¡æ¯ã€‚

![guiji2.png](/post/message-queue/guiji2.png)

## ç¨³å®šæ€§&æ€§èƒ½

#### é«˜å¯ç”¨

æ•°æ®å¤‡ä»½å’Œæ•…éšœè½¬ç§»
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20441/1666871933931-97904c34-ab95-4778-9266-8a724d652213.png#clientId=uecce1891-4c1f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=242&id=ue475ed04&margin=%5Bobject%20Object%5D&name=image.png&originHeight=483&originWidth=1037&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59699&status=done&style=none&taskId=u85dd854e-7f54-4fe9-8d6c-addca350b18&title=&width=518.5)

##### æ¶ˆè´¹ä¸€è‡´æ€§

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20441/1666873658825-a41e31e0-f7dd-44e7-910c-f1a497841dd2.png#clientId=uecce1891-4c1f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=153&id=ubf45f24c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=306&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=155906&status=done&style=none&taskId=ud3f002cb-af85-4049-9add-af69a19790c&title=&width=540)
LogEndOffsetï¼šæ¯ä¸ªpartitionçš„logæœ€åä¸€æ¡Messageçš„ä½ç½®ã€‚
HighWatermarkï¼šå–æœ€å°LEOï¼Œconsumerèƒ½å¤Ÿçœ‹åˆ°çš„æ­¤partitionçš„ä½ç½®ã€‚

#### é«˜æ€§èƒ½

##### é›¶æ‹·è´

##### ç£ç›˜é¡ºåºè¯»å†™


#### rocketmq

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20156646/1667303564561-2f07e1f6-7659-42fd-af1c-e6158b2b660d.png#clientId=ub92ab98a-bea2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=540&id=u0afcf2aa&margin=%5Bobject%20Object%5D&name=image.png&originHeight=540&originWidth=750&originalType=binary&ratio=1&rotation=0&showTitle=false&size=151090&status=done&style=none&taskId=u69fe3af1-8ba5-496f-b9cd-2e6f00ec9b2&title=&width=750)

##### 1. é€»è¾‘åˆ†åŒº

ä¸ºäº†æå‡æ•´ä½“çš„ååé‡ä¸æä¾›è·¨å‰¯æœ¬ç»„çš„é«˜å¯ç”¨èƒ½åŠ›ï¼ŒRocketMQ æœåŠ¡ç«¯ä¸€èˆ¬ä¼šä¸ºå•ä¸ª Topic åˆ›å»ºå¤šä¸ªé€»è¾‘åˆ†åŒºï¼Œå³åœ¨å¤šä¸ªå‰¯æœ¬ç»„ä¸Šå„è‡ªç»´æŠ¤éƒ¨åˆ†åˆ†åŒº (
Partition)ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸ºé˜Ÿåˆ— (MessageQueue)ã€‚åŒä¸€ä¸ªå‰¯æœ¬ç»„ä¸ŠåŒä¸€ä¸ª Topic çš„é˜Ÿåˆ—æ•°ç›¸åŒå¹¶ä» 0 å¼€å§‹è¿ç»­ç¼–å·ï¼Œä¸åŒå‰¯æœ¬ç»„ä¸Šçš„ MessageQueue æ•°é‡å¯ä»¥ä¸åŒã€‚
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20156646/1667211128802-1ebe1226-c430-4b6b-a95b-64ae84602146.png#clientId=u732f2838-f0ad-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=610&id=u13a63bf6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=610&originWidth=750&originalType=binary&ratio=1&rotation=0&showTitle=false&size=217091&status=done&style=none&taskId=u1a163547-d3c6-45a3-bacb-68c9b9605a3&title=&width=750)
æ¯ä¸ªTopicåœ¨Brokerä¸Šä¼šåˆ’åˆ†æˆå‡ ä¸ªé€»è¾‘é˜Ÿåˆ—ï¼Œæ¯ä¸ªé€»è¾‘é˜Ÿåˆ—ä¿å­˜ä¸€éƒ¨åˆ†æ¶ˆæ¯æ•°æ®ã€‚ä»ä¸Šé¢æ¨¡å‹å¯ä»¥çœ‹å‡ºï¼Œè¦è§£å†³æ¶ˆè´¹å¹¶å‘ï¼Œå°±æ˜¯è¦åˆ©ç”¨Queue,ä¸€ä¸ªTopicå¯ä»¥åˆ†å‡ºæ›´å¤šçš„queue,æ¯ä¸€ä¸ªqueueå¯ä»¥å­˜æ”¾åœ¨ä¸åŒçš„ç¡¬ä»¶ä¸Šæ¥æé«˜å¹¶å‘ã€‚

##### 2. æŒä¹…åŒ–

åœ¨RocketMQä¸­æ¶ˆæ¯åˆ·ç›˜ä¸»è¦å¯ä»¥åˆ†ä¸ºåŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ä¸¤ç§ã€‚
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20156646/1667301973880-fbab5567-a642-42b6-8ead-7fa8e666e23d.png#clientId=ub92ab98a-bea2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=540&id=u5e5e4647&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=583&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48292&status=done&style=none&taskId=u1e3a47a0-19e3-4baa-b8f2-559591abd3e&title=&width=347)
æ¶ˆæ¯å†™å…¥å†…å­˜çš„PAGECACHEåï¼Œç«‹åˆ»é€šçŸ¥åˆ·ç›˜çº¿ç¨‹åˆ·ç›˜ï¼Œç„¶åç­‰å¾…åˆ·ç›˜å®Œæˆï¼Œåˆ·ç›˜çº¿ç¨‹æ‰§è¡Œå®Œæˆåå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¿”å›æ¶ˆæ¯å†™æˆåŠŸçš„çŠ¶æ€ã€‚

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20156646/1667302024113-a2ca21dc-b78c-4e84-a005-2a84c19c0f75.png#clientId=ub92ab98a-bea2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=592&id=ud39bf6fa&margin=%5Bobject%20Object%5D&name=image.png&originHeight=906&originWidth=542&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49898&status=done&style=none&taskId=uc5830126-bfa6-4900-9880-40955d7f100&title=&width=354)
åœ¨è¿”å›å†™æˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½åªæ˜¯è¢«å†™å…¥äº†å†…å­˜çš„PAGECACHEï¼Œå†™æ“ä½œçš„è¿”å›å¿«ï¼Œååé‡å¤§ï¼›å½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œç»Ÿä¸€è§¦å‘å†™ç£ç›˜æ“ä½œï¼Œå¿«é€Ÿå†™å…¥ã€‚

##### 3. æ¶ˆæ¯å‘é€

ä¸‰ç§å‘é€æ–¹å¼ï¼šåŒæ­¥/å¼‚æ­¥/å•å‘

æ¶ˆæ¯å‘é€çš„è¿”å›çŠ¶æ€æœ‰å¦‚ä¸‹å››ç§ : FLUSH_DISK_TIMEOUT ã€ FLUSH_SLAVE_TIMEOUT ã€SLAVE_NOT_AVAILABLE
ã€SEND_OKï¼Œä¸åŒçŠ¶æ€åœ¨ä¸åŒçš„åˆ·ç›˜ç­–ç•¥å’ŒåŒæ­¥ç­–ç•¥çš„é…ç½®ä¸‹å«ä¹‰æ˜¯ä¸åŒçš„ ã€‚
**FLUSH_DISK_TIMEOUT** : è¡¨ç¤ºæ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å®Œæˆåˆ·ç›˜(éœ€è¦ Broker çš„åˆ·ç›˜ç­–è¢«è®¾ç½®æˆ SYNC_FLUSH æ‰ä¼šæŠ¥è¿™ä¸ªé”™è¯¯) ã€‚
**FLUSH_SLAVE_TIMEOUT** :è¡¨ç¤ºåœ¨ä¸»å¤‡æ–¹å¼ä¸‹ï¼Œå¹¶ä¸” Brokerè¢«è®¾ ç½® æˆ SYNC_MASTER æ–¹å¼ï¼Œæ²¡æœ‰åœ¨è®¾å®šæ—¶é—´å†…å®Œæˆ ä¸»ä»åŒæ­¥ ã€‚
**SLAVE_NOT_AVAILABLE** : è¿™ä¸ªçŠ¶æ€ äº§ç”Ÿçš„åœºæ™¯å’Œ FLUSH_SLAVE_TIMEOUT ç±»ä¼¼ï¼Œ è¡¨ç¤ºåœ¨ä¸»å¤‡ æ–¹å¼ä¸‹ï¼Œå¹¶ä¸” Brokerè¢«è®¾ç½®æˆ SYNC_MASTERï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°è¢«é…ç½®æˆ
Slave çš„ Brokerã€‚
**SEND_ OK** :è¡¨ç¤ºå‘é€æˆåŠŸï¼Œå‘é€æˆåŠŸçš„å…·ä½“å«ä¹‰ï¼Œæ¯”å¦‚æ¶ˆæ¯æ˜¯å¦å·²ç» è¢«å­˜å‚¨åˆ°èç›˜?æ¶ˆæ¯æ˜¯å¦è¢«åŒæ­¥åˆ°äº† Slaveä¸Š?æ¶ˆæ¯åœ¨ Slaveä¸Šæ˜¯å¦è¢«
å†™äººç£ç›˜?éœ€è¦ç»“åˆæ‰€é…ç½®çš„åˆ·ç›˜ç­–ç•¥ã€ä¸»ä»ç­–ç•¥æ¥å®š ã€‚ è¿™ä¸ªçŠ¶æ€è¿˜å¯ ä»¥ç®€å•ç†è§£ä¸ºï¼Œæ²¡æœ‰å‘ç”Ÿä¸Šé¢åˆ—å‡ºçš„ ä¸‰ä¸ªé—®é¢˜çŠ¶æ€å°±æ˜¯ SEND OKã€‚

##### 4. æ‰¹é‡ç”Ÿäº§/æ¶ˆè´¹

æ‰¹é‡æ¶ˆæ¯æ˜¯æŒ‡å°†å¤šæ¡å°çš„æ¶ˆæ¯åˆå¹¶æˆä¸€ä¸ªæ‰¹é‡æ¶ˆæ¯ï¼Œä¸€æ¬¡å‘é€å‡ºå»ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥å‡å°‘ç½‘ç»œIOï¼Œæå‡ååé‡ã€‚
æ¯”å¦‚è¯´åŸæœ¬æˆ‘æœ‰ä¸‰æ¡æ¶ˆæ¯,å¦‚æœä¸‰æ¡æ¶ˆæ¯åˆ†ä¸‰æ¬¡å‘çš„è¯,ä¼šèµ°ä¸‰æ¬¡ç½‘ç»œIO,å¦‚æœæˆ‘ç»™ä¸‰æ¡æ¶ˆæ¯æ•´æˆä¸€èµ·å‘é€,è¿™æ ·å°±èµ°ä¸€æ¬¡ç½‘ç»œäº†ã€‚
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/20156646/1667304196521-865cb3ee-ab0d-4c62-90e5-7b6cf5bff2f4.png#clientId=ub92ab98a-bea2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=846&id=uec728440&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1402&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220474&status=done&style=none&taskId=u2ccac6c3-73d4-409a-9418-120c3c6ec4c&title=&width=1402)

## æ€»ç»“

ç›®å‰å›¢é˜Ÿä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å…¸å‹ä¾‹å­ï¼š

|                                         | SOFAMQç‰¹æ€§     | Msgbrokerç‰¹æ€§                        |
| --------------------------------------- | -------------- | ------------------------------------ |
| infosec->infosectaskäº‹ä»¶æ¶ˆæ¯            | å †ç§¯           |                                      |
| infosectask->itaskæµå®¡æ¶ˆæ¯              | å¤±è´¥é‡è¯•ã€å †ç§¯ |                                      |
| infosectask->infostudioèƒ½åŠ›å¼‚æ­¥ç»“æœè½®è¯¢ | å»¶è¿Ÿæ¶ˆæ¯       |                                      |
| infosecé«˜ä¿åœºæ™¯æ¥å…¥                     |                | äº‹åŠ¡æ¶ˆæ¯ã€å­˜å‚¨é«˜å¯é                  |
| infosecäº‹ä»¶å¼‚æ­¥ç»“æœ                     |                | å¼‚æ­¥ã€è§£è€¦ã€å­˜å‚¨é«˜å¯é ã€æ¨æ¨¡å¼å®æ—¶å¼º |

## å‚è€ƒæ–‡æ¡£

- æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¯­ä¹‰å’ŒæŠ•é€’è¯­ä¹‰ï¼š[https://juejin.cn/post/6844903872029278215](https://juejin.cn/post/6844903872029278215)
- Msgbrokerï¼š[https://yuque.antfin.com/middleware/msgbroker/pubsub](https://yuque.antfin.com/middleware/msgbroker/pubsub)
- SOFAMQï¼š[https://yuque.antfin.com/middleware/sofamq/common_msg](https://yuque.antfin.com/middleware/sofamq/common_msg)
- æ¶ˆæ¯å¹‚ç­‰ï¼š[https://help.aliyun.com/document_detail/177412.html](https://help.aliyun.com/document_detail/177412.html)
- kafkaæ—¶é—´è½®ï¼š[https://mp.weixin.qq.com/s/l5Kpg45-4MkOq_xfUczPPA](https://mp.weixin.qq.com/s/l5Kpg45-4MkOq_xfUczPPA)
- msgbroker
  æ¶ˆæ¯è½¨è¿¹ï¼š[https://developer.alipay.com/post/496000358?inviterWorkNo=322773](https://developer.alipay.com/post/496000358?inviterWorkNo=322773)
- rocketmqå»¶è¿Ÿæ¶ˆæ¯ï¼š[https://mp.weixin.qq.com/s/iZL8M88gF7s5NmW7DYyYDQ](https://mp.weixin.qq.com/s/iZL8M88gF7s5NmW7DYyYDQ)
