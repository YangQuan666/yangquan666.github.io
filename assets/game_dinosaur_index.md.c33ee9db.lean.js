var _=Object.defineProperty;var I=(n,t,e)=>t in n?_(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var x=(n,t,e)=>(I(n,typeof t!="symbol"?t+"":t,e),e);import{r as R,o as M,a as L,e as k,f as D,g as S,h as Y}from"./chunks/framework.148ca673.js";import{u as C}from"./chunks/quasar.esm.prod.61603a4f.js";const l={birdUp:{h:52,w:84,x:708,y:31},birdDown:{h:60,w:84,x:708,y:85},cactus:{h:92,w:46,x:70,y:31},cactusDouble:{h:66,w:64,x:118,y:31},cactusDoubleB:{h:92,w:80,x:184,y:31},cactusTriple:{h:66,w:82,x:266,y:31},cloud:{h:28,w:92,x:794,y:31},dino:{h:86,w:80,x:350,y:31},dinoDuckLeftLeg:{h:52,w:110,x:596,y:31},dinoDuckRightLeg:{h:52,w:110,x:596,y:85},dinoLeftLeg:{h:86,w:80,x:432,y:31},dinoRightLeg:{h:86,w:80,x:514,y:31},ground:{h:28,w:2400,x:0,y:2},replayIcon:{h:60,w:68,x:0,y:31}},y=new Map;function B(n,t){if(y.has(t))return y.get(t);const e=l[t],i=[],s=n.width*e.y*4;for(let a=s;a<s+e.h*n.width*4;a+=n.width*8){const o=[],h=a+e.x*4;for(let r=h;r<h+e.w*4;r+=8)o.push(n.data[r+3]===0?0:1);i.push(o)}return y.set(t,i),i}class m{constructor(t){this._sprite=null,this.height=0,this.width=0,this.x=0,this.y=0,t&&(this.imageData=t,this.alphaMap=[])}set sprite(t){this._sprite=t,this.height=l[t].h/2,this.width=l[t].w/2,this.imageData&&(this.alphaMap=B(this.imageData,t))}get sprite(){return this._sprite}get rightX(){return this.width+this.x}get bottomY(){return this.height+this.y}hits(t){return t.some(e=>{if(!e||this.x>=e.rightX||e.x>=this.rightX||this.y>=e.bottomY||e.y>=this.bottomY)return!1;if(this.alphaMap&&e.alphaMap){const i=Math.round(Math.max(this.y,e.y)),s=Math.round(Math.min(this.bottomY,e.bottomY)),a=Math.round(Math.max(this.x,e.x)),o=Math.round(Math.min(this.rightX,e.rightX)),h=Math.round(this.y),r=Math.round(e.y),d=Math.round(this.x),c=Math.round(e.x);for(let p=i;p<s;p++)for(let g=a;g<o;g++)if(this.alphaMap[p-h][g-d]!==0&&e.alphaMap[p-r][g-c]!==0)return!0;return!1}return!0})}}const v=class extends m{constructor(t){super(t),this.wingFrames=0,this.wingDirection="Up",this.sprite=`bird${this.wingDirection}`,this.x=null,this.y=null,this.speed=null,this.wingsRate=null}nextFrame(){this.x-=this.speed,this.determineSprite()}determineSprite(){const t=this.height;if(this.wingFrames>=this.wingsRate&&(this.wingDirection=this.wingDirection==="Up"?"Down":"Up",this.wingFrames=0),this.sprite=`bird${this.wingDirection}`,this.wingFrames++,this.height!==t){let e=v.wingSpriteYShift;this.wingDirection==="Up"&&(e*=-1),this.y+=e}}};let u=v;x(u,"maxBirdHeight",Math.max(l.birdUp.h,l.birdDown.h)/2),x(u,"wingSpriteYShift",6);function P(n){const{width:t,height:e}=n,i=document.createElement("canvas"),s=i.getContext("2d");let a;return i.width=t,i.height=e,s.drawImage(n,0,0),a=s.getImageData(0,0,t,e),i.remove(),a}async function X(n){return new Promise((t,e)=>{const i=new Image;i.onload=()=>t(i),i.onerror=e,i.src=n})}function T(n){const t=n.slice(n.lastIndexOf(".")),e=n.split("/");return e[e.length-1].slice(0,-1*t.length)}async function j(n,t){t||(t=T(n));const e=document.createElement("style");e.innerHTML=`
    @font-face {
      font-family: ${t};
      src: url(${n});
    }
  `,document.head.appendChild(e),await document.fonts.load(`12px ${t}`)}function w(n,t){return Math.floor(Math.random()*(t-n+1))+n}function b(){return!!w(0,1)}function $(n){return n[w(0,n.length-1)]}const G=["cactus","cactusDouble","cactusDoubleB","cactusTriple"];class V extends m{constructor(t){super(t),this.sprite=$(G),this.speed=null,this.x=null,this.y=null}nextFrame(){this.x-=this.speed}}class A extends m{constructor(t){super(),this.sprite="cloud",this.speedMod=w(6,14)/10,this.speed=null,this.x=null,this.y=null}nextFrame(){this.x-=this.speed*this.speedMod}}class O extends m{constructor(t){super(t),this.isDucking=!1,this.legFrames=0,this.legShowing="Left",this.sprite=`dino${this.legShowing}Leg`,this.vVelocity=null,this.baseY=0,this.relativeY=0,this.legsRate=null,this.lift=null,this.gravity=null}get y(){return this.baseY-this.height+this.relativeY}set y(t){this.baseY=t}reset(){this.isDucking=!1,this.legFrames=0,this.legShowing="Left",this.sprite=`dino${this.legShowing}Leg`,this.vVelocity=null,this.relativeY=0}jump(){return this.relativeY===0?(this.vVelocity=-this.lift,!0):!1}duck(t){this.isDucking=!!t}nextFrame(){this.vVelocity!==null&&(this.vVelocity+=this.gravity,this.relativeY+=this.vVelocity),this.relativeY>0&&(this.vVelocity=null,this.relativeY=0),this.determineSprite()}determineSprite(){this.relativeY<0?this.sprite="dino":(this.legFrames>=this.legsRate&&(this.legShowing=this.legShowing==="Left"?"Right":"Left",this.legFrames=0),this.isDucking?this.sprite=`dinoDuck${this.legShowing}Leg`:this.sprite=`dino${this.legShowing}Leg`,this.legFrames++)}}const E="/game/dino/jump.mp3",U="/game/dino/level-up.mp3",z="/game/dino/game-over.mp3",W={jump:E,"level-up":U,"game-over":z},F=R();typeof Audio<"u"&&(F.value=new Audio);function f(n){const t=F.value;t.src=W[n],t.play().catch(e=>{console.error("播放音频时出错：",e)})}class q{constructor(){this.looping=!1,this.preloaded=!1,this.targetFrameRate=60,this.frameCount=0,this.frameRate=0,this.paused=!1,this.stepFrames=null,this._lastFrameTime=Date.now(),this.__loop=this._loop.bind(this)}async start(t=!1){this.preloaded||(this.preload&&await this.preload(),this.preloaded=!0),t&&(this.paused=t),this.looping=!0,t||window.requestAnimationFrame(this.__loop)}stop(){this.looping=!1}pause(){this.paused=!0}unpause(){this.paused=!1}step(t=1){typeof this.stepFrames=="number"?this.stepFrames+=t:this.stepFrames=t,this.__loop(Date.now())}_loop(t){const e=Date.now(),i=e-this._lastFrameTime,s=1e3/this.targetFrameRate;if(i>=s-5&&(this.onFrame(),this.frameRate=1e3/(e-this._lastFrameTime),this._lastFrameTime=e,this.frameCount++),this.looping){let a=!0;this.paused&&(typeof this.stepFrames=="number"?this.stepFrames===0?(this.stepFrames=null,a=!1):this.stepFrames--:a=!1),a&&window.requestAnimationFrame(this.__loop)}}}class H extends q{constructor(t,e,i){super(),this.width=null,this.height=null,this.spriteImage=null,this.spriteImageData=null,this.defaultSettings={bgSpeed:8,birdSpeed:7.2,birdSpawnRate:240,birdWingsRate:15,cactiSpawnRate:50,cloudSpawnRate:200,cloudSpeed:2,dinoGravity:.5,dinoGroundOffset:4,dinoLegsRate:6,dinoLift:10,scoreBlinkRate:20,scoreIncreaseRate:6},this.state={settings:{...this.defaultSettings},birds:[],cacti:[],clouds:[],dino:null,gameOver:!1,groundX:0,groundY:0,isRunning:!1,level:0,score:{blinkFrames:0,blinks:0,isBlinking:!1,value:0}}}createCanvas(t,e,i){const s=document.createElement("canvas"),a=s.getContext("2d"),o=window.devicePixelRatio;this.width=t,this.height=e,s.style.width=t+"px",s.style.height=e+"px",s.width=Math.floor(t*o),s.height=Math.floor(e*o),a.scale(o,o),i.appendChild(s),this.canvasCtx=a}async preload(){const{settings:t}=this.state,[e]=await Promise.all([X("/game/dino/sprite.png"),j("/game/dino/PressStart2P-Regular.ttf","PressStart2P")]);this.spriteImage=e,this.spriteImageData=P(e);const i=new O(this.spriteImageData);i.legsRate=t.dinoLegsRate,i.lift=t.dinoLift,i.gravity=t.dinoGravity,i.x=25,i.baseY=this.height-t.dinoGroundOffset,this.state.dino=i,this.state.groundY=this.height-l.ground.h/2}onFrame(){const{state:t}=this;this.drawBackground(),this.drawGround(),this.drawClouds(),this.drawDino(),this.drawScore(),t.isRunning&&(this.drawCacti(),t.level>3&&this.drawBirds(),t.dino.hits([t.cacti[0],t.birds[0]])&&(f("game-over"),t.gameOver=!0),t.gameOver?this.endGame():this.updateScore())}onInput(t){const{state:e}=this;switch(t){case"jump":{e.isRunning?e.dino.jump()&&f("jump"):(this.resetGame(),e.dino.jump(),f("jump"));break}case"duck":{e.isRunning&&e.dino.duck(!0);break}case"stop-duck":{e.isRunning&&e.dino.duck(!1);break}}}resetGame(){this.state.dino.reset(),Object.assign(this.state,{settings:{...this.defaultSettings},birds:[],cacti:[],gameOver:!1,isRunning:!0,level:0,score:{blinkFrames:0,blinks:0,isBlinking:!1,value:0}}),this.start()}endGame(){const t=l.replayIcon,e=15;this.paintText("G A M E  O V E R",this.width/2,this.height/2-e,{font:"PressStart2P",size:"12px",align:"center",baseline:"bottom",color:"#535353"}),this.paintSprite("replayIcon",this.width/2-t.w/4,this.height/2-t.h/4+e),this.state.isRunning=!1,this.drawScore(),this.stop()}increaseDifficulty(){const{birds:t,cacti:e,clouds:i,dino:s,settings:a}=this.state,{bgSpeed:o,cactiSpawnRate:h,dinoLegsRate:r}=a,{level:d}=this.state;d>4&&d<8?(a.bgSpeed++,a.birdSpeed=a.bgSpeed*.8):d>7&&(a.bgSpeed=Math.ceil(o*1.1),a.birdSpeed=a.bgSpeed*.9,a.cactiSpawnRate=Math.floor(h*.98),d>7&&d%2===0&&r>3&&a.dinoLegsRate--);for(const c of t)c.speed=a.birdSpeed;for(const c of e)c.speed=a.bgSpeed;for(const c of i)c.speed=a.bgSpeed;s.legsRate=a.dinoLegsRate}updateScore(){const{state:t}=this;if(this.frameCount%t.settings.scoreIncreaseRate===0){const e=t.level;t.score.value++,t.level=Math.floor(t.score.value/100),t.level!==e&&(f("level-up"),this.increaseDifficulty(),t.score.isBlinking=!0)}}drawFPS(){this.paintText("fps: "+Math.round(this.frameRate),0,0,{font:"PressStart2P",size:"12px",baseline:"top",align:"left",color:"#535353"})}drawBackground(){this.canvasCtx.fillStyle="#f7f7f7",this.canvasCtx.fillRect(0,0,this.width,this.height)}drawGround(){const{state:t}=this,{bgSpeed:e}=t.settings,i=l.ground.w/2;this.paintSprite("ground",t.groundX,t.groundY),t.groundX-=e,t.groundX<=-i+this.width&&(this.paintSprite("ground",t.groundX+i,t.groundY),t.groundX<=-i&&(t.groundX=-e))}drawClouds(){const{clouds:t,settings:e}=this.state;if(this.progressInstances(t),this.frameCount%e.cloudSpawnRate===0){const i=new A;i.speed=e.bgSpeed,i.x=this.width,i.y=w(20,80),t.push(i)}this.paintInstances(t)}drawDino(){const{dino:t}=this.state;t.nextFrame(),this.paintSprite(t.sprite,t.x,t.y)}drawCacti(){const{state:t}=this,{cacti:e,settings:i}=t;if(this.progressInstances(e),this.frameCount%i.cactiSpawnRate===0&&!t.birds.length&&b()){const s=new V(this.spriteImageData);s.speed=i.bgSpeed,s.x=this.width,s.y=this.height-s.height-2,e.push(s)}this.paintInstances(e)}drawBirds(){const{birds:t,settings:e}=this.state;if(this.progressInstances(t),this.frameCount%e.birdSpawnRate===0&&b()){const i=new u(this.spriteImageData);i.speed=e.birdSpeed,i.wingsRate=e.birdWingsRate,i.x=this.width,i.y=this.height-u.maxBirdHeight-u.wingSpriteYShift-5-l.dinoDuckLeftLeg.h/2-e.dinoGroundOffset,t.push(i)}this.paintInstances(t)}drawScore(){const{canvasCtx:t,state:e}=this,{isRunning:i,score:s,settings:a}=e,o=12;let h=!0,r=s.value;i&&s.isBlinking&&(s.blinkFrames++,s.blinkFrames%a.scoreBlinkRate===0&&s.blinks++,s.blinks>7?(s.blinkFrames=0,s.blinks=0,s.isBlinking=!1):s.blinks%2===0?r=Math.floor(r/100)*100:h=!1),h&&(t.fillStyle="#f7f7f7",t.fillRect(this.width-o*5,0,o*5,o),this.paintText((r+"").padStart(5,"0"),this.width,0,{font:"PressStart2P",size:`${o}px`,align:"right",baseline:"top",color:"#535353"}))}progressInstances(t){for(let e=t.length-1;e>=0;e--){const i=t[e];i.nextFrame(),i.rightX<=0&&t.splice(e,1)}}paintInstances(t){for(const e of t)this.paintSprite(e.sprite,e.x,e.y)}paintSprite(t,e,i){const{h:s,w:a,x:o,y:h}=l[t];this.canvasCtx.drawImage(this.spriteImage,o,h,a,s,e,i,a/2,s/2)}paintText(t,e,i,s){const{font:a="serif",size:o="12px"}=s,{canvasCtx:h}=this;h.font=`${o} ${a}`,s.align&&(h.textAlign=s.align),s.baseline&&(h.textBaseline=s.baseline),s.color&&(h.fillStyle=s.color),h.fillText(t,e,i)}}const J={class:"row"},K={class:"col-12 offset-sm-3 col-sm-6"},N={__name:"Dinosaur",setup(n){const t=R(),i=C().platform.has.touch,s=new H;M(()=>{const r=t.value;s.createCanvas(r.offsetWidth,400,r),s.start().catch(console.error),i?r.addEventListener("touchstart",a):typeof window<"u"&&(window.addEventListener("keydown",o),window.addEventListener("keyup",h))}),L(()=>{console.log(s),s.stop(),!i&&typeof window<"u"&&(window.removeEventListener("keydown",o),window.removeEventListener("keyup",h))});const a=()=>{s.onInput("jump")},o=r=>{r.key==="ArrowUp"||r.key===" "?s.onInput("jump"):r.key==="ArrowDown"&&s.onInput("duck")},h=r=>{r.key==="ArrowDown"&&(console.log("键盘-向下-解除"),s.onInput("stop-duck"))};return(r,d)=>(k(),D("div",J,[S("div",K,[S("div",{ref_key:"gamePanelRef",ref:t},null,512)])]))}},it=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"game/dinosaur/index.md","filePath":"game/dinosaur/index.md","lastUpdated":1684303541000}'),Q={name:"game/dinosaur/index.md"},st=Object.assign(Q,{setup(n){return(t,e)=>(k(),D("div",null,[Y(N)]))}});export{it as __pageData,st as default};
